<!doctype html>
<html lang="ja" class="light">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>学マス スコア最適化 & 比較</title>
        <link rel="manifest" href="manifest.json">
        <meta name="theme-color" content="#1976d2">
        <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
        <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="default">
        <meta name="apple-mobile-web-app-title" content="GakmasCalc">
        <link rel="apple-touch-icon" href="icon-192.png">
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet" />
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            tailwind.config = {
                darkMode: "class",
                theme: {
                    fontFamily: {
                        sans: ["Noto Sans JP", "sans-serif"],
                    },
                    extend: {
                        colors: {
                            slate: {
                                850: "#1e293b",
                                950: "#020617",
                            },
                            indigo: {
                                50: "#fff7ed",
                                100: "#ffedd5",
                                200: "#fed7aa",
                                300: "#fdba74",
                                400: "#fb923c",
                                500: "#f97316",
                                600: "#ea580c",
                                700: "#c2410c",
                                800: "#9a3412",
                                900: "#7c2d12",
                                950: "#431407",
                            },
                        },
                    },
                },
            };
        </script>
        <style>
            body {
                font-family: "Noto Sans JP", sans-serif;
                transition: background-color 0.3s, color 0.3s;
            }
            /* トグルスイッチの動作 */
            .toggle-checkbox:checked {
                right: 0;
                border-color: #f97316;
            }
            .toggle-checkbox:checked + .toggle-label {
                background-color: #ea580c;
            }
            /* カスタムスクロールバー（ダークモード用） */
            .dark ::-webkit-scrollbar {
                width: 8px;
            }
            .dark ::-webkit-scrollbar-track {
                background: #0f172a;
            }
            .dark ::-webkit-scrollbar-thumb {
                background: #334155;
                border-radius: 4px;
            }
            .dark ::-webkit-scrollbar-thumb:hover {
                background: #475569;
            }
        </style>
    </head>
    <body
        class="bg-slate-100 text-slate-800 dark:bg-slate-950 dark:text-slate-200 p-4 md:p-8 transition-colors duration-300"
    >
        <div class="max-w-6xl mx-auto relative">
            <div class="absolute top-0 right-0 z-10">
                <button
                    id="theme_toggle"
                    class="p-2 rounded-full bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 shadow-sm border border-slate-200 dark:border-slate-700 transition-all focus:outline-none"
                >
                    <svg
                        id="icon_sun"
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-6 w-6 hidden dark:block"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
                        />
                    </svg>
                    <svg
                        id="icon_moon"
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-6 w-6 block dark:hidden"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                        />
                    </svg>
                </button>
            </div>

            <header class="mb-6 pr-12">
                <h1
                    class="text-2xl font-bold text-slate-800 dark:text-slate-100"
                >
                    ダメージ最適化比較ツール
                </h1>
                <p class="text-slate-500 dark:text-slate-400 text-sm">
                    現在のリソース配分と、特定された計算式に基づいた理想配分を比較します
                </p>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <div class="lg:col-span-4 space-y-4">
                    <!-- Plan Type Selector -->
                    <div
                        class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 p-5 transition-colors duration-300"
                    >
                        <h2
                            class="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase mb-4 border-b dark:border-slate-800 pb-2"
                        >
                            プラン
                        </h2>
                        <div class="grid grid-cols-4 gap-2">
                            <label class="cursor-pointer">
                                <input
                                    type="radio"
                                    name="plan_type"
                                    value="sense"
                                    class="peer sr-only"
                                    checked
                                />
                                <div
                                    class="rounded-lg border border-slate-200 dark:border-slate-700 p-2 text-center peer-checked:border-indigo-500 peer-checked:bg-indigo-50 dark:peer-checked:bg-indigo-900/20 peer-checked:text-indigo-600 dark:peer-checked:text-indigo-300 transition-all hover:bg-slate-50 dark:hover:bg-slate-800"
                                >
                                    <span class="font-bold text-xs sm:text-sm"
                                        >センス</span
                                    >
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input
                                    type="radio"
                                    name="plan_type"
                                    value="logic"
                                    class="peer sr-only"
                                />
                                <div
                                    class="rounded-lg border border-slate-200 dark:border-slate-700 p-2 text-center peer-checked:border-blue-500 peer-checked:bg-blue-50 dark:peer-checked:bg-blue-900/20 peer-checked:text-blue-600 dark:peer-checked:text-blue-300 transition-all hover:bg-slate-50 dark:hover:bg-slate-800"
                                >
                                    <span class="font-bold text-xs sm:text-sm"
                                        >ロジック</span
                                    >
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input
                                    type="radio"
                                    name="plan_type"
                                    value="anomaly"
                                    class="peer sr-only"
                                />
                                <div
                                    class="rounded-lg border border-slate-200 dark:border-slate-700 p-2 text-center peer-checked:border-purple-500 peer-checked:bg-purple-50 dark:peer-checked:bg-purple-900/20 peer-checked:text-purple-600 dark:peer-checked:text-purple-300 transition-all hover:bg-slate-50 dark:hover:bg-slate-800"
                                >
                                    <span class="font-bold text-xs sm:text-sm"
                                        >アノマリー</span
                                    >
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input
                                    type="radio"
                                    name="plan_type"
                                    value="custom"
                                    class="peer sr-only"
                                />
                                <div
                                    class="rounded-lg border border-slate-200 dark:border-slate-700 p-2 text-center peer-checked:border-indigo-500 peer-checked:bg-indigo-50 dark:peer-checked:bg-indigo-900/20 peer-checked:text-indigo-600 dark:peer-checked:text-indigo-300 transition-all hover:bg-slate-50 dark:hover:bg-slate-800"
                                >
                                    <span class="font-bold text-xs sm:text-sm"
                                        >カスタム</span
                                    >
                                </div>
                            </label>
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 p-5 transition-colors duration-300"
                    >
                        <h2
                            class="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase mb-4 border-b dark:border-slate-800 pb-2"
                        >
                            現在のステータス
                        </h2>

                        <div
                            class="mb-4 flex flex-col gap-2 bg-indigo-50 dark:bg-indigo-900/20 p-3 rounded-lg border border-indigo-100 dark:border-indigo-900/30"
                        >
                            <div class="flex items-center justify-between">
                                <span
                                    class="text-sm font-bold text-indigo-900 dark:text-indigo-300"
                                    >絶好調</span
                                >
                                <div
                                    class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in"
                                >
                                    <input
                                        type="checkbox"
                                        name="toggle"
                                        id="is_super_cond"
                                        class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer peer checked:right-0 checked:border-indigo-600 right-4 top-0 transition-all duration-300"
                                        checked
                                    />
                                    <label
                                        for="is_super_cond"
                                        class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 dark:bg-slate-600 cursor-pointer peer-checked:bg-indigo-600 transition-colors duration-300"
                                    ></label>
                                </div>
                            </div>
                        </div>

                        <div
                            id="row_sense"
                            data-plan-group="sense custom"
                            class="grid grid-cols-2 gap-3 mb-3"
                        >
                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1"
                                    >集中</label
                                >
                                <input
                                    type="number"
                                    id="actual_conc"
                                    value="50"
                                    class="w-full p-2 border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-indigo-500 input-param"
                                />
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1"
                                    >好調</label
                                >
                                <input
                                    type="number"
                                    id="actual_cond"
                                    value="50"
                                    class="w-full p-2 border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-indigo-500 input-param"
                                />
                            </div>
                        </div>

                        <div
                            data-plan-group="logic custom"
                            class="mb-3 flex flex-col gap-2 bg-fuchsia-50 dark:bg-fuchsia-900/20 p-3 rounded-lg border border-fuchsia-100 dark:border-fuchsia-900/30 pt-3 border-t border-slate-100 dark:border-slate-800 hidden"
                        >
                            <div class="flex items-center justify-between">
                                <span
                                    class="text-sm font-bold text-fuchsia-900 dark:text-fuchsia-300"
                                    >プライドバフ</span
                                >
                                <div
                                    class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in"
                                >
                                    <input
                                        type="checkbox"
                                        name="toggle"
                                        id="pride_buff_toggle"
                                        class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer peer checked:right-0 checked:border-fuchsia-600 right-4 top-0 transition-all duration-300"
                                    />
                                    <label
                                        for="pride_buff_toggle"
                                        class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 dark:bg-slate-600 cursor-pointer peer-checked:bg-fuchsia-600 transition-colors duration-300"
                                    ></label>
                                </div>
                            </div>
                            <p
                                class="text-[11px] text-fuchsia-600 dark:text-fuchsia-300"
                            >
                                有効時、好印象とやる気の小さい方×2%をスコア上昇量増加に加算
                            </p>
                        </div>

                        <div
                            id="row_logic"
                            data-plan-group="logic custom"
                            class="grid grid-cols-2 gap-3 mb-3 hidden"
                        >
                            <div>
                                <label
                                    class="block text-xs font-bold text-pink-600 dark:text-pink-500 mb-1"
                                    >好印象</label
                                >
                                <input
                                    type="number"
                                    id="logic_impression"
                                    value="0"
                                    class="w-full p-2 border border-pink-200 dark:border-pink-900/50 bg-pink-50 dark:bg-pink-900/10 text-pink-800 dark:text-pink-200 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-pink-500 input-param"
                                />
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-sky-600 dark:text-sky-500 mb-1"
                                    >やる気</label
                                >
                                <input
                                    type="number"
                                    id="logic_motivation"
                                    value="50"
                                    class="w-full p-2 border border-sky-200 dark:border-sky-900/50 bg-sky-50 dark:bg-sky-900/10 text-sky-800 dark:text-sky-200 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-sky-500 input-param"
                                />
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-emerald-600 dark:text-emerald-500 mb-1"
                                    >元気</label
                                >
                                <input
                                    type="number"
                                    id="logic_genki"
                                    value="50"
                                    class="w-full p-2 border border-emerald-200 dark:border-emerald-900/50 bg-emerald-50 dark:bg-emerald-900/10 text-emerald-800 dark:text-emerald-200 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-emerald-500 input-param"
                                />
                            </div>
                        </div>
                        <div
                            id="row_anomaly"
                            data-plan-group="anomaly custom"
                            class="grid grid-cols-2 gap-3 mb-3 pt-3 border-t border-slate-100 dark:border-slate-800 hidden"
                        >
                            <div>
                                <label
                                    class="block text-xs font-bold text-amber-600 dark:text-amber-500 mb-1"
                                    >成長</label
                                >
                                <input
                                    type="number"
                                    id="actual_growth"
                                    value="0"
                                    class="w-full p-2 border border-amber-200 dark:border-amber-900/50 bg-amber-50 dark:bg-amber-900/10 text-amber-800 dark:text-amber-200 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-amber-500 input-param"
                                />
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-rose-600 dark:text-rose-500 mb-1"
                                    >熱意</label
                                >
                                <input
                                    type="number"
                                    id="actual_enthusiasm"
                                    value="0"
                                    class="w-full p-2 border border-rose-200 dark:border-rose-900/50 bg-rose-50 dark:bg-rose-900/10 text-rose-800 dark:text-rose-200 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-rose-500 input-param"
                                />
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-teal-600 dark:text-teal-500 mb-1"
                                    >累計全力値</label
                                >
                                <input
                                    type="number"
                                    id="actual_total_allout"
                                    value="0"
                                    class="w-full p-2 border border-teal-200 dark:border-teal-900/50 bg-teal-50 dark:bg-teal-900/10 text-teal-800 dark:text-teal-200 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-teal-500 input-param"
                                />
                            </div>
                            <div class="col-span-2 text-[10px] text-slate-400">
                                指針倍率は下部の「係数・環境設定」で設定します
                            </div>
                        </div>

                        <div
                            id="total_res_box"
                            class="bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-xl border border-indigo-100 dark:border-indigo-900/30 text-center mt-4 transition-colors duration-300"
                        >
                            <p
                                class="text-xs text-indigo-500 dark:text-indigo-400 font-bold uppercase tracking-wider mb-1"
                            >
                                合計リソース (プラン主要2項目)
                            </p>
                            <p
                                class="text-2xl font-black text-indigo-700 dark:text-indigo-300"
                                id="total_res_display"
                            >
                                0
                            </p>
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 p-5 transition-colors duration-300"
                    >
                        <h2
                            class="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase mb-4 border-b dark:border-slate-800 pb-2"
                        >
                            カード情報
                        </h2>
                        <div class="space-y-3">
                            <div>
                                <div
                                    class="flex items-center justify-between mb-1"
                                >
                                    <label
                                        class="block text-xs font-bold text-slate-500 dark:text-slate-400"
                                        >基礎スコア</label
                                    >
                                    <select
                                        id="base_mode"
                                        class="text-xs border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-indigo-500 input-param"
                                    >
                                        <option value="fixed" selected>
                                            固定値
                                        </option>
                                        <option
                                            value="conc_percent"
                                            data-plan-group="sense custom"
                                        >
                                            集中の%
                                        </option>
                                        <option
                                            value="cond_percent"
                                            data-plan-group="sense custom"
                                        >
                                            好調の%
                                        </option>
                                        <option
                                            value="genki_percent"
                                            data-plan-group="logic custom"
                                        >
                                            元気の%
                                        </option>
                                        <option
                                            value="motivation_percent"
                                            data-plan-group="logic custom"
                                        >
                                            やる気の%
                                        </option>
                                        <option
                                            value="impression_percent"
                                            data-plan-group="logic custom"
                                        >
                                            好印象の%
                                        </option>
                                        <option
                                            value="allout_percent"
                                            data-plan-group="anomaly custom"
                                        >
                                            累計全力値%
                                        </option>
                                    </select>
                                </div>
                                <input
                                    type="number"
                                    id="base"
                                    value="15"
                                    step="0.1"
                                    class="w-full p-2 border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-indigo-500 input-param"
                                />
                                <p
                                    id="resolved_base_note"
                                    class="text-[10px] text-indigo-500 dark:text-indigo-300 mt-1"
                                >
                                    実際に計算に使われる基礎スコア:
                                </p>
                            </div>
                            <div
                                data-plan-group="sense custom"
                                class="grid grid-cols-2 gap-3"
                            >
                                <div>
                                    <label
                                        class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1"
                                        >集中係数</label
                                    >
                                    <input
                                        type="number"
                                        id="n_conc"
                                        value="1.0"
                                        step="0.1"
                                        class="w-full p-2 border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-indigo-500 input-param"
                                    />
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1"
                                        >好調係数</label
                                    >
                                    <input
                                        type="number"
                                        id="n_cond"
                                        value="1.0"
                                        step="0.1"
                                        class="w-full p-2 border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-indigo-500 input-param"
                                    />
                                </div>
                            </div>
                            <div data-plan-group="sense custom">
                                <label
                                    class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1"
                                    >集中強化 (%)</label
                                >
                                <input
                                    type="number"
                                    id="conc_boost"
                                    value="0"
                                    class="w-full p-2 border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-indigo-500 input-param"
                                />
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div id="row_stance">
                                    <label
                                        class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1"
                                        >指針倍率</label
                                    >
                                    <select
                                        id="stance_mult"
                                        class="w-full p-2 border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-indigo-500 input-param"
                                    >
                                        <option value="0">
                                            のんびり x0.00
                                        </option>
                                        <option value="0.25">
                                            温存2段階目 x0.25
                                        </option>
                                        <option value="0.5">
                                            温存1段階目 x0.50
                                        </option>
                                        <option value="1" selected>
                                            なし x1.00
                                        </option>
                                        <option value="2">
                                            強気1段階目 x2.00
                                        </option>
                                        <option value="2.5">
                                            強気2段階目 x2.50
                                        </option>
                                        <option value="3">全力 x3.00</option>
                                    </select>
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1"
                                        >スコア上昇量増加(%)</label
                                    >
                                    <input
                                        type="number"
                                        id="buff_rate"
                                        value="0"
                                        class="w-full p-2 border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-indigo-500 input-param"
                                    />
                                </div>
                            </div>
                            <div data-plan-group="anomaly custom">
                                <label
                                    class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1"
                                    >累計全力値加算率 (%)</label
                                >
                                <input
                                    type="number"
                                    id="allout_rate"
                                    value="0"
                                    class="w-full p-2 border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-indigo-500 input-param"
                                />
                            </div>
                            <div
                                data-plan-group="anomaly custom"
                                class="flex items-center justify-between"
                            >
                                <div>
                                    <p
                                        class="text-xs font-bold text-amber-600 dark:text-amber-400"
                                    >
                                        成長不適用（持続/発動予約）
                                    </p>
                                    <p class="text-[10px] text-slate-400">
                                        持続や発動予約で成長が乗らない場合にON
                                    </p>
                                </div>
                                <div
                                    class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in"
                                >
                                    <input
                                        type="checkbox"
                                        id="anomaly_growth_disable_toggle"
                                        class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer peer checked:right-0 checked:border-amber-500 right-4 top-0 transition-all duration-300"
                                    />
                                    <label
                                        for="anomaly_growth_disable_toggle"
                                        class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 dark:bg-slate-600 cursor-pointer peer-checked:bg-amber-500 transition-colors duration-300"
                                    ></label>
                                </div>
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1"
                                    >ターンボーナス (%)</label
                                >
                                <input
                                    type="number"
                                    id="turn_bonus"
                                    value="1500"
                                    class="w-full p-2 border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-indigo-500 input-param"
                                />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-8 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="damage_display_container">
                        <div
                            id="current_dmg_box"
                            class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 p-6 border-l-4 border-l-slate-300 dark:border-l-slate-600 transition-colors duration-300"
                        >
                            <div class="flex justify-between items-start">
                                <div>
                                    <p
                                        class="text-xs font-bold text-slate-400 uppercase tracking-wider"
                                        id="current_dmg_label"
                                    >
                                        Current Damage
                                    </p>
                                    <p
                                        class="text-3xl font-black text-slate-700 dark:text-slate-200 mt-1"
                                        id="current_dmg"
                                    >
                                        0
                                    </p>
                                </div>
                                <div class="text-right">
                                    <span
                                        class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 text-xs font-bold px-2 py-1 rounded"
                                        >現在</span
                                    >
                                    <p
                                        class="text-xs text-slate-500 dark:text-slate-400 mt-1"
                                        id="current_ratio"
                                    >
                                        --
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div
                            id="optimal_dmg_box"
                            class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 p-6 border-l-4 border-l-indigo-500 bg-indigo-50/50 dark:bg-indigo-900/10 transition-colors duration-300"
                        >
                            <div class="flex justify-between items-start">
                                <div>
                                    <p
                                        class="text-xs font-bold text-indigo-400 uppercase tracking-wider"
                                    >
                                        Optimal Damage
                                    </p>
                                    <p
                                        class="text-3xl font-black text-indigo-700 dark:text-indigo-300 mt-1"
                                        id="optimal_dmg"
                                    >
                                        0
                                    </p>
                                </div>
                                <div class="text-right">
                                    <span
                                        class="bg-indigo-100 dark:bg-indigo-900/40 text-indigo-600 dark:text-indigo-300 text-xs font-bold px-2 py-1 rounded"
                                        >理想</span
                                    >
                                    <p
                                        class="text-xs text-indigo-600 dark:text-indigo-400 mt-1 font-bold"
                                        id="optimal_ratio"
                                    >
                                        --
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 p-6 transition-colors duration-300"
                    >
                        <div class="flex justify-between items-end mb-4">
                            <h3
                                class="font-bold text-slate-700 dark:text-slate-200"
                            >
                                配分シミュレーション
                            </h3>
                            <p
                                id="diff_text"
                                class="text-sm font-bold text-slate-400"
                            >
                                機会損失: 0
                            </p>
                        </div>
                        <div class="h-64 relative w-full">
                            <canvas id="optChart"></canvas>
                        </div>
                        <div class="h-64 relative w-full mt-8 hidden" id="optChart2Container">
                            <canvas id="optChart2"></canvas>
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden transition-colors duration-300"
                    >
                        <div
                            class="bg-slate-50 dark:bg-slate-800 border-b dark:border-slate-700 px-6 py-3"
                        >
                            <h3
                                class="font-bold text-slate-700 dark:text-slate-200 text-sm"
                            >
                                計算ステップ詳細比較
                            </h3>
                        </div>
                        <table class="w-full text-sm text-left">
                            <thead
                                class="text-slate-500 dark:text-slate-400 bg-slate-50/50 dark:bg-slate-800/50 border-b dark:border-slate-700"
                            >
                                <tr>
                                    <th
                                        class="px-6 py-3 font-medium text-xs uppercase w-1/3"
                                    >
                                        Step
                                    </th>
                                    <th
                                        class="px-6 py-3 font-medium text-xs uppercase w-1/3"
                                    >
                                        現在の構成
                                    </th>
                                    <th
                                        class="px-6 py-3 font-medium text-xs uppercase w-1/3 text-indigo-600 dark:text-indigo-400"
                                    >
                                        理想的な構成
                                    </th>
                                </tr>
                            </thead>
                            <tbody
                                class="divide-y divide-slate-100 dark:divide-slate-700 text-slate-700 dark:text-slate-300"
                                id="step_table"
                            ></tbody>
                        </table>
                        
                        <div class="mt-4 p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg text-xs font-mono text-slate-500 dark:text-slate-400 break-all">
                            <p class="font-bold mb-1 text-slate-400 dark:text-slate-500 uppercase tracking-wider">計算式 (現在の構成)</p>
                            <div id="formula_display"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            /**
             * Core Logic Module
             * 計算ロジックを純粋関数として分離
             */
            const Calculator = (() => {
                const round = (val, mode) => {
                    const v = Number(val.toFixed(10));
                    switch (mode) {
                        case "ceil":
                            return Math.ceil(v);
                        case "floor":
                            return Math.floor(v);
                        case "round":
                            return Math.round(v);
                        default:
                            return v;
                    }
                };

                const resolveBase = (baseVal, mode, sources) => {
                    const safe = sources || {};
                    const {
                        conc = 0,
                        cond = 0,
                        genki = 0,
                        motivation = 0,
                        impression = 0,
                        totalAllout = 0,
                    } = safe;
                    switch (mode) {
                        case "conc_percent":
                            return conc * (baseVal / 100);
                        case "cond_percent":
                            return cond * (baseVal / 100);
                        case "genki_percent":
                            return genki * (baseVal / 100);
                        case "motivation_percent":
                            return motivation * (baseVal / 100);
                        case "impression_percent":
                            return impression * (baseVal / 100);
                        case "allout_percent":
                            return totalAllout * (baseVal / 100);
                        default:
                            return baseVal;
                    }
                };

                const isLogicLikePlan = (planType) =>
                    planType === "logic" || planType === "anomaly";

                const getConditionContext = (isSuper, cond) => {
                    if (!isSuper) {
                        return {
                            condMultBase: cond > 0 ? 0.5 : 0,
                            labelPrefix: cond > 0 ? "好調" : "通常",
                        };
                    }
                    if (cond > 0) {
                        return {
                            condMultBase: 0.5 + cond / 10.0,
                            labelPrefix: "絶好調",
                        };
                    }
                    return { condMultBase: 0, labelPrefix: "通常" };
                };

                const getPrideBuff = ({ prideBuffEnabled, impression, motivation }) =>
                    prideBuffEnabled
                        ? Math.min(0.5, 0.02 * Math.min(impression ?? 0, motivation ?? 0))
                        : 0;

                const buildFormula = ({
                    conc,
                    effectiveNConc,
                    concBoostMult,
                    resolvedBase,
                    growth,
                    enthusiasm,
                    val1,
                    condMultBase,
                    effectiveNCond,
                    stance,
                    val2,
                    totalBuff,
                    val3,
                    turn,
                    val4,
                }) => {
                    const formulaParts = [];
                    const concBoostText = concBoostMult !== 1 ? `×${concBoostMult}` : "";
                    const concCoeffExpr = `${conc}×${effectiveNConc}`;
                    const concAfterExpr = `ceil(${concCoeffExpr})${concBoostText}`;
                    const step1Expr = `${resolvedBase.toFixed(1)} + ${concAfterExpr} + ${growth} + ${enthusiasm}`;
                    formulaParts.push(`1. 基礎: ${step1Expr} = ${val1.toFixed(2)}`);

                    const condStr =
                        effectiveNCond > 0
                            ? `(1 + ${condMultBase}×${effectiveNCond})`
                            : "1";
                    const step2Expr = `${val1.toFixed(2)} × ${condStr} × ${stance}`;
                    formulaParts.push(`2. 倍率: ${step2Expr} = ${val2.toFixed(2)}`);

                    const step3Expr = `${val2.toFixed(2)} × (1 + ${totalBuff.toFixed(3)})`;
                    formulaParts.push(`3. バフ: ceil(${step3Expr}) = ${val3.toFixed(2)}`);

                    const step4Expr = `${val3.toFixed(2)} × ${turn}`;
                    formulaParts.push(`4. 最終: ceil(${step4Expr}) = ${val4.toFixed(2)}`);

                    return formulaParts.join("<br>");
                };

                const calculateDamage = (params) => {
                    const {
                        base,
                        baseMode,
                        conc,
                        nConc,
                        cond,
                        nCond,
                        stance,
                        buff,
                        turn,
                        growth,
                        enthusiasm,
                        isSuper,
                        baseSources,
                        planType,
                        impression,
                        motivation,
                        prideBuffEnabled,
                        concBoost,
                    } = params;
                    const steps = [];
                    const isLogicLike = isLogicLikePlan(planType);
                    const effectiveNConc = isLogicLike ? 0 : nConc;
                    const effectiveNCond = isLogicLike ? 0 : nCond;

                    const resolvedBase = resolveBase(
                        base,
                        baseMode ?? "fixed",
                        baseSources ?? { conc, cond },
                    );

                    const concBoostMult = 1 + (concBoost || 0) / 100;

                    // Fixed: boostTiming="after", step1Mode="conc_after"
                    const concCoeff = conc * effectiveNConc;
                    const concTermFinal = round(concCoeff, "ceil") * concBoostMult;

                    const raw1 =
                        resolvedBase + concTermFinal + growth + enthusiasm;
                    const val1 = raw1;
                    steps.push({ label: "基礎スコア", val: val1 });

                    const { condMultBase, labelPrefix } = getConditionContext(
                        isSuper,
                        cond,
                    );
                    const totalCondMult = 1 + condMultBase * effectiveNCond;
                    
                    const raw2 = val1 * totalCondMult * stance;
                    const val2 = raw2;
                    steps.push({ label: `${labelPrefix}・指針`, val: val2 });

                    const prideBuff = getPrideBuff({
                        prideBuffEnabled,
                        impression,
                        motivation,
                    });
                    const totalBuff = buff + prideBuff;
                    const raw3 = val2 * (1 + totalBuff);
                    const val3 = round(raw3, "ceil");
                    steps.push({ label: "スコア上昇量増加", val: val3 });

                    // Step 4: ターン倍率 (Ceil)
                    const raw4 = val3 * turn;
                    const val4 = round(raw4, "ceil");
                    steps.push({ label: "最終ダメージ", val: val4 });

                    const formula = buildFormula({
                        conc,
                        effectiveNConc,
                        concBoostMult,
                        resolvedBase,
                        growth,
                        enthusiasm,
                        val1,
                        condMultBase,
                        effectiveNCond,
                        stance,
                        val2,
                        totalBuff,
                        val3,
                        turn,
                        val4,
                    });

                    return { final: val4, steps, resolvedBase, formula };
                };

                const isLogicPridePlan = (params) =>
                    params.planType === "logic" && params.prideBuffEnabled;

                const resolveMainTotalRes = (params, totalResOverride, isLogicPride) => {
                    if (typeof totalResOverride === "number") {
                        return totalResOverride;
                    }
                    if (isLogicPride) {
                        return (params.motivation || 0) + (params.impression || 0);
                    }
                    return (params.conc || 0) + (params.cond || 0);
                };

                const shouldSkipOptimization = (params) =>
                    params.planType === "anomaly" ||
                    (params.planType === "logic" && !params.prideBuffEnabled);

                const buildMainSimParams = (params, xValue, yValue, isLogicPride) => {
                    if (isLogicPride) {
                        return {
                            ...params,
                            motivation: xValue,
                            impression: yValue,
                            baseSources: {
                                ...(params.baseSources || {}),
                                motivation: xValue,
                                impression: yValue,
                            },
                        };
                    }
                    return {
                        ...params,
                        conc: xValue,
                        cond: yValue,
                        baseSources: {
                            ...(params.baseSources || {}),
                            conc: xValue,
                            cond: yValue,
                        },
                    };
                };

                const runMainOptimization = (params, totalRes, isLogicPride) => {
                    let maxDmg = -1;
                    let bestConc = 0;
                    let bestResult = null;
                    const chartData = { labels: [], data: [] };

                    for (let c = 0; c <= totalRes; c++) {
                        const currentResB = totalRes - c;
                        const simParams = buildMainSimParams(
                            params,
                            c,
                            currentResB,
                            isLogicPride,
                        );
                        const res = calculateDamage(simParams);

                        chartData.labels.push(c);
                        chartData.data.push(res.final);

                        if (res.final > maxDmg) {
                            maxDmg = res.final;
                            bestConc = c;
                            bestResult = res;
                        }
                    }

                    return { maxDmg, bestConc, bestResult, chartData };
                };

                const shouldLinkCustomCond = (params) =>
                    ((params.cond || 0) === (params.impression || 0) &&
                        (params.impression || 0) !== 0) ||
                    ((params.cond || 0) === 0 && (params.impression || 0) === 0);

                const buildCustomSecondaryParams = (params, motivation, impression) => {
                    const baseEnthusiasm =
                        (params.enthusiasm || 0) - (params.motivation || 0);
                    const simParams = {
                        ...params,
                        motivation,
                        enthusiasm: baseEnthusiasm + motivation,
                        impression,
                        baseSources: {
                            ...(params.baseSources || {}),
                            motivation,
                            impression,
                        },
                    };

                    if (shouldLinkCustomCond(params)) {
                        simParams.cond = impression;
                    }
                    return simParams;
                };

                const runCustomSecondaryOptimization = (params) => {
                    let maxDmg2 = -1;
                    let bestRes2 = 0;
                    const chartData2 = { labels: [], data: [] };
                    const totalRes2 = (params.motivation || 0) + (params.impression || 0);

                    for (let m = 0; m <= totalRes2; m++) {
                        const currentImp = totalRes2 - m;
                        const simParams2 = buildCustomSecondaryParams(
                            params,
                            m,
                            currentImp,
                        );
                        const res2 = calculateDamage(simParams2);

                        chartData2.labels.push(m);
                        chartData2.data.push(res2.final);

                        if (res2.final > maxDmg2) {
                            maxDmg2 = res2.final;
                            bestRes2 = m;
                        }
                    }

                    return { chartData2, maxDmg2, bestRes2 };
                };

                const simulateOptimal = (params, totalResOverride) => {
                    const isCustom = params.planType === "custom";
                    const isLogicPride = isLogicPridePlan(params);
                    const totalRes = resolveMainTotalRes(
                        params,
                        totalResOverride,
                        isLogicPride,
                    );
                    const skipOptimization = shouldSkipOptimization(params);

                    if (skipOptimization) {
                        const currentResult = calculateDamage(params);
                        const chartData = { labels: [], data: [] };
                        chartData.labels.push(
                            isLogicPride ? params.motivation : params.conc,
                        );
                        chartData.data.push(currentResult.final);
                        return {
                            maxDmg: currentResult.final,
                            bestConc: isLogicPride
                                ? params.motivation
                                : params.conc,
                            bestResult: currentResult,
                            chartData,
                            skipOptimization: true,
                        };
                    }

                    const mainResult = runMainOptimization(
                        params,
                        totalRes,
                        isLogicPride,
                    );
                    const customResult = isCustom
                        ? runCustomSecondaryOptimization(params)
                        : null;

                    return {
                        maxDmg: mainResult.maxDmg,
                        bestConc: mainResult.bestConc,
                        bestResult: mainResult.bestResult,
                        chartData: mainResult.chartData,
                        chartData2: customResult ? customResult.chartData2 : null,
                        maxDmg2: customResult ? customResult.maxDmg2 : null,
                        bestRes2: customResult ? customResult.bestRes2 : null,
                        skipOptimization: false,
                        isCustom,
                    };
                };

                return { calculateDamage, simulateOptimal };
            })();

            /**
             * Theme Manager
             * ダークモード切り替え管理
             */
            const ThemeManager = (() => {
                let isDark = false;

                const init = () => {
                    // 保存された設定またはシステム設定を確認
                    if (
                        localStorage.theme === "dark" ||
                        (!("theme" in localStorage) &&
                            window.matchMedia("(prefers-color-scheme: dark)")
                                .matches)
                    ) {
                        isDark = true;
                    } else {
                        isDark = false;
                    }
                    apply();
                };

                const toggle = () => {
                    isDark = !isDark;
                    localStorage.theme = isDark ? "dark" : "light";
                    apply();
                    // チャートの色も更新するためイベント発火またはコールバック呼び出しが必要だが、
                    // 簡易的にApp.updateを呼ぶ設計にする
                    return isDark;
                };

                const apply = () => {
                    if (isDark) {
                        document.documentElement.classList.add("dark");
                    } else {
                        document.documentElement.classList.remove("dark");
                    }
                };

                const getChartColors = () => {
                    return isDark
                        ? {
                              grid: "#334155", // slate-700
                              text: "#94a3b8", // slate-400
                              line: "#fb923c", // orange-400
                          }
                        : {
                              grid: "#e2e8f0", // slate-200
                              text: "#64748b", // slate-500
                              line: "#f97316", // orange-500
                          };
                };

                return { init, toggle, getChartColors, isDark: () => isDark };
            })();

            /**
             * UI Controller
             */
            const App = (() => {
                let chartInstance = null;
                let chartInstance2 = null;

                const els = {
                    inputs: document.querySelectorAll(
                        ".input-param, #is_super_cond, #pride_buff_toggle, #anomaly_growth_disable_toggle",
                    ),
                    themeBtn: document.getElementById("theme_toggle"),
                    display: {
                        totalResBox: document.getElementById("total_res_box"),
                        totalRes: document.getElementById("total_res_display"),
                        currentDmg: document.getElementById("current_dmg"),
                        currentLabel: document.getElementById("current_dmg_label"),
                        optimalDmg: document.getElementById("optimal_dmg"),
                        optimalBox: document.getElementById("optimal_dmg_box"),
                        damageContainer: document.getElementById("damage_display_container"),
                        currentRatio: document.getElementById("current_ratio"),
                        optimalRatio: document.getElementById("optimal_ratio"),
                        diffText: document.getElementById("diff_text"),
                        stepTable: document.getElementById("step_table"),
                        resolvedBaseNote:
                            document.getElementById("resolved_base_note"),
                        formula: document.getElementById("formula_display"),
                    },
                    chartCanvas: document.getElementById("optChart"),
                    chartCanvas2: document.getElementById("optChart2"),
                    chart2Container: document.getElementById("optChart2Container"),
                };

                const BASE_MODE_LABELS = {
                    conc_percent: "集中%",
                    cond_percent: "好調%",
                    genki_percent: "元気%",
                    motivation_percent: "やる気%",
                    impression_percent: "好印象%",
                    allout_percent: "累計全力値%",
                };

                const getBaseModeLabel = (state) => {
                    const label = BASE_MODE_LABELS[state.baseMode];
                    if (!label) return "固定値";
                    return `${label} (${state.base.toFixed(2)}%)`;
                };

                const getRatioLabels = (state) => {
                    const isLogicPride =
                        state.planType === "logic" && state.prideBuffEnabled;
                    if (state.planType === "logic") {
                        return {
                            labelA: isLogicPride ? "やる気" : "元気",
                            labelB: "好印象",
                        };
                    }
                    if (state.planType === "anomaly") {
                        return { labelA: "熱意", labelB: "成長" };
                    }
                    return { labelA: "集中", labelB: "好調" };
                };

                const applyOptimizationLayout = (skipOptimization) => {
                    const { damageContainer, optimalBox, currentLabel } =
                        els.display;
                    if (skipOptimization) {
                        damageContainer?.classList.remove("md:grid-cols-2");
                        optimalBox?.classList.add("hidden");
                        if (currentLabel) currentLabel.innerText = "Damage / Score";
                        return;
                    }

                    damageContainer?.classList.add("md:grid-cols-2");
                    optimalBox?.classList.remove("hidden");
                    if (currentLabel) currentLabel.innerText = "Current Damage";
                };

                const buildMarkerSeries = (labels, values, targetX, targetY) =>
                    labels.map((label, idx) =>
                        Math.abs(label - targetX) < 0.1 ? targetY ?? values[idx] : null,
                    );

                const setHidden = (element, shouldHide) => {
                    if (!element) return;
                    element.classList.toggle("hidden", shouldHide);
                };

                const isPlanVisible = (plan, planGroup) =>
                    plan === "custom" || planGroup.split(" ").includes(plan);

                const setChartAxisByPlan = (planAdjusted) => {
                    if (planAdjusted.planType === "custom") {
                        els.chart2Container?.classList.remove("hidden");
                        if (chartInstance) {
                            chartInstance.options.scales.x.title.text = "集中 (Conc)";
                        }
                        if (chartInstance2) {
                            chartInstance2.options.scales.x.title.text =
                                "やる気 (Motivation)";
                        }
                        return;
                    }

                    els.chart2Container?.classList.add("hidden");
                    if (!chartInstance) return;
                    const isLogicPride =
                        planAdjusted.planType === "logic" &&
                        planAdjusted.prideBuffEnabled;
                    chartInstance.options.scales.x.title.text = isLogicPride
                        ? "やる気 (Motivation)"
                        : "集中 (Conc)";
                };

                const getState = () => {
                    const getVal = (id) =>
                        parseFloat(document.getElementById(id)?.value) || 0;
                    const getInt = (id) =>
                        parseInt(document.getElementById(id)?.value) || 0;
                    const planType = document.querySelector(
                        'input[name="plan_type"]:checked',
                    )?.value;
                    return {
                        planType,
                        conc: getInt("actual_conc"),
                        cond: getInt("actual_cond"),
                        growth: getInt("actual_growth"),
                        enthusiasm: getInt("actual_enthusiasm"),
                        genki: getInt("logic_genki"),
                        motivation: getInt("logic_motivation"),
                        impression: getInt("logic_impression"),
                        concBoost:
                            planType === "sense" || planType === "custom"
                                ? getVal("conc_boost")
                                : 0,
                        totalAllout: getInt("actual_total_allout"),
                        isSuper:
                            document.getElementById("is_super_cond").checked,
                        base: getVal("base"),
                        baseMode: document.getElementById("base_mode").value,
                        nConc: getVal("n_conc"),
                        nCond: getVal("n_cond"),
                        stance: getVal("stance_mult"),
                        buff: getVal("buff_rate") / 100,
                        turn: getVal("turn_bonus") / 100,
                        alloutRate: getVal("allout_rate") / 100,
                        anomalyGrowthDisabled:
                            document.getElementById(
                                "anomaly_growth_disable_toggle",
                            )?.checked || false,
                        prideBuffEnabled:
                            document.getElementById("pride_buff_toggle")
                                ?.checked || false,
                    };
                };

                const init = () => {
                    ThemeManager.init();
                    initChart();
                    attachEvents();
                    const selectedPlan =
                        document.querySelector(
                            'input[name="plan_type"]:checked',
                        )?.value || "sense";
                    updatePlanVisibility(selectedPlan);
                    update();
                };

                const bindInputEvents = () => {
                    els.inputs.forEach((input) =>
                        input.addEventListener("input", update),
                    );
                    document
                        .getElementById("base_mode")
                        .addEventListener("change", update);
                };

                const bindPlanTypeEvents = () => {
                    document
                        .querySelectorAll('input[name="plan_type"]')
                        .forEach((radio) =>
                            radio.addEventListener("change", (e) => {
                                updatePlanVisibility(e.target.value);
                                update();
                            }),
                        );
                };

                const bindThemeEvent = () => {
                    els.themeBtn.addEventListener("click", () => {
                        ThemeManager.toggle();
                        updateChartTheme();
                    });
                };

                const attachEvents = () => {
                    bindInputEvents();
                    bindPlanTypeEvents();
                    bindThemeEvent();
                };

                const initChart = () => {
                    const ctx = els.chartCanvas.getContext("2d");
                    const ctx2 = els.chartCanvas2.getContext("2d");
                    const colors = ThemeManager.getChartColors();

                    const createConfig = (xLabel) => ({
                        type: "line",
                        data: {
                            labels: [],
                            datasets: [
                                {
                                    label: "ダメージ",
                                    data: [],
                                    borderColor: colors.line,
                                    borderWidth: 2,
                                    tension: 0.3,
                                    pointRadius: 0,
                                    pointHoverRadius: 4,
                                },
                                {
                                    label: "現在",
                                    data: [],
                                    pointRadius: 6,
                                    pointBackgroundColor: "#64748b",
                                    pointBorderColor: "#fff",
                                    pointBorderWidth: 2,
                                    showLine: false,
                                },
                                {
                                    label: "理想",
                                    data: [],
                                    pointRadius: 6,
                                    pointBackgroundColor: "#f97316",
                                    pointBorderColor: "#fff",
                                    pointBorderWidth: 2,
                                    showLine: false,
                                },
                            ],
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { mode: "index", intersect: false },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: (ctx) =>
                                            `ダメージ: ${Number(ctx.raw.toFixed(2)).toLocaleString()}`,
                                    },
                                },
                            },
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: xLabel,
                                        color: colors.text,
                                        font: { size: 10 },
                                    },
                                    grid: { display: false },
                                    ticks: { color: colors.text },
                                },
                                y: {
                                    ticks: {
                                        callback: (val) => val.toLocaleString(),
                                        color: colors.text,
                                    },
                                    grid: { color: colors.grid },
                                },
                            },
                        },
                    });

                    chartInstance = new Chart(ctx, createConfig("集中 (Conc) の値"));
                    chartInstance2 = new Chart(ctx2, createConfig("やる気 (Motiv) の値"));
                };

                // テーマ切り替え時にチャートの設定を更新
                const updateChartTheme = () => {
                    const colors = ThemeManager.getChartColors();

                    [chartInstance, chartInstance2].forEach(chart => {
                        if (!chart) return;
                        chart.options.scales.x.title.color = colors.text;
                        chart.options.scales.x.ticks.color = colors.text;
                        chart.options.scales.y.ticks.color = colors.text;
                        chart.options.scales.y.grid.color = colors.grid;
                        chart.data.datasets[0].borderColor = colors.line;
                        chart.update();
                    });
                };

                const getTotalRes = (state, planAdjusted) => {
                    if (state.planType === "anomaly") return 0;
                    if (state.planType === "logic") {
                        return state.prideBuffEnabled
                            ? (state.motivation || 0) + (state.impression || 0)
                            : 0;
                    }
                    return (planAdjusted.conc || 0) + (planAdjusted.cond || 0);
                };

                const toggleTotalResBox = (planType, prideEnabled) => {
                    if (!els.display.totalResBox) return;
                    const shouldHide =
                        planType === "anomaly" ||
                        (planType === "logic" && !prideEnabled);
                    if (shouldHide) {
                        els.display.totalResBox.classList.add("hidden");
                    } else {
                        els.display.totalResBox.classList.remove("hidden");
                    }
                };

                const update = () => {
                    const state = getState();
                    const planAdjusted = mapPlanParams(state);
                    const totalRes = getTotalRes(state, planAdjusted);

                    toggleTotalResBox(state.planType, state.prideBuffEnabled);
                    if (els.display.totalRes) {
                        els.display.totalRes.innerText = totalRes;
                    }
                    const currentResult =
                        Calculator.calculateDamage(planAdjusted);
                    const modeLabel = getBaseModeLabel(state);
                    if (els.display.resolvedBaseNote) {
                        els.display.resolvedBaseNote.innerText = `実際に計算に使われる基礎スコア (${modeLabel}): ${Number(currentResult.resolvedBase.toFixed(2)).toLocaleString()}`;
                    }
                    const simResult = Calculator.simulateOptimal(
                        planAdjusted,
                        totalRes,
                    );

                    renderResults(
                        planAdjusted,
                        currentResult,
                        simResult,
                        totalRes,
                    );

                    setChartAxisByPlan(planAdjusted);

                    updateChartData(planAdjusted, simResult);
                };


                const renderStepRows = (current, best) =>
                    current.steps
                        .map((step, i) => {
                            const optStep = best.bestResult
                                ? best.bestResult.steps[i]
                                : step;
                            const isDifferent =
                                Math.abs(step.val - optStep.val) > 0.001;
                            const diffClass = isDifferent
                                ? "bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 font-bold"
                                : "text-slate-500 dark:text-slate-400";

                            return `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                    <td class="px-6 py-3 font-mono text-xs text-slate-400 border-r border-slate-100 dark:border-slate-800">Step ${i + 1}. <br><span class="text-slate-600 dark:text-slate-300 font-sans">${step.label}</span></td>
                    <td class="px-6 py-3 font-bold text-slate-700 dark:text-slate-200">${Number(step.val.toFixed(2)).toLocaleString()}</td>
                    <td class="px-6 py-3 ${diffClass}">${Number(optStep.val.toFixed(2)).toLocaleString()}</td>
                </tr>
            `;
                        })
                        .join("");
                const renderResults = (state, current, best, totalRes) => {
                    els.display.currentDmg.innerText = Number(
                        current.final.toFixed(0),
                    ).toLocaleString();
                    els.display.optimalDmg.innerText = Number(
                        best.maxDmg.toFixed(0),
                    ).toLocaleString();
                    const { labelA, labelB } = getRatioLabels(state);
                    
                    let currentRatioText = `${labelA} ${state.conc} : ${labelB} ${state.cond}`;
                    let optimalRatioText = `${labelA} ${best.bestConc} : ${labelB} ${totalRes - best.bestConc}`;

                    if (state.planType === "custom" && state.prideBuffEnabled) {
                        currentRatioText += ` / やる気 ${state.motivation || 0} : 好印象 ${state.impression || 0}`;
                        if (best.bestRes2 !== null) {
                             const totalRes2 = (state.motivation || 0) + (state.impression || 0);
                             optimalRatioText += ` / やる気 ${best.bestRes2} : 好印象 ${totalRes2 - best.bestRes2}`;
                        }
                    }

                    els.display.currentRatio.innerText = currentRatioText;
                    els.display.optimalRatio.innerText = optimalRatioText;

                    const diff = best.maxDmg - current.final;
                    const diffPct =
                        best.maxDmg > 0
                            ? ((diff / best.maxDmg) * 100).toFixed(1)
                            : 0;

                    applyOptimizationLayout(best.skipOptimization);

                    if (best.skipOptimization) {
                        els.display.diffText.innerHTML = `<span class="text-slate-500">最適化対象外 (ロジック/アノマリー または プライド無効)</span>`;
                    } else {
                        els.display.diffText.innerHTML =
                            diff > 0.001
                                ? `<span class="text-rose-500">機会損失: ${Math.floor(diff).toLocaleString()} (-${diffPct}%)</span>`
                                : `<span class="text-emerald-500">最適構成です (Loss: 0%)</span>`;
                    }

                    const rows = renderStepRows(current, best);

                    if (els.display.formula) {
                        const formula = current.formula || "";
                        els.display.formula.innerHTML = formula;
                    }
                    els.display.stepTable.innerHTML = rows;
                };

                const updateChartData = (planAdjusted, simResult) => {
                    if (!chartInstance) return;
                    
                    const labels = simResult.chartData.labels;
                    const data = simResult.chartData.data;
                    const currentConc = planAdjusted.planType === "logic" && planAdjusted.prideBuffEnabled
                        ? planAdjusted.motivation
                        : planAdjusted.conc;

                    chartInstance.data.labels = labels;
                    chartInstance.data.datasets[0].data = data;

                    chartInstance.data.datasets[1].data = buildMarkerSeries(
                        labels,
                        data,
                        currentConc,
                    );
                    chartInstance.data.datasets[2].data = buildMarkerSeries(
                        labels,
                        data,
                        simResult.bestConc,
                        simResult.maxDmg,
                    );
                    chartInstance.update();

                    if (simResult.isCustom && chartInstance2 && simResult.chartData2) {
                        const labels2 = simResult.chartData2.labels;
                        const data2 = simResult.chartData2.data;
                        const currentMotiv = planAdjusted.motivation;

                        chartInstance2.data.labels = labels2;
                        chartInstance2.data.datasets[0].data = data2;

                        chartInstance2.data.datasets[1].data = buildMarkerSeries(
                            labels2,
                            data2,
                            currentMotiv,
                        );
                        chartInstance2.data.datasets[2].data = buildMarkerSeries(
                            labels2,
                            data2,
                            simResult.bestRes2,
                            simResult.maxDmg2,
                        );
                        chartInstance2.update();
                    }
                };

                const updatePlanGroupVisibility = (plan) => {
                    const groups = document.querySelectorAll("[data-plan-group]");
                    groups.forEach((element) => {
                        const visible = isPlanVisible(plan, element.dataset.planGroup);
                        setHidden(element, !visible);
                    });
                };

                const updateBaseModeVisibility = (plan) => {
                    const baseSelect = document.getElementById("base_mode");
                    const baseOptions = document.querySelectorAll(
                        "#base_mode option[data-plan-group]",
                    );
                    let mustResetBase = false;

                    baseOptions.forEach((option) => {
                        const visible = isPlanVisible(plan, option.dataset.planGroup);
                        setHidden(option, !visible);
                        if (!visible && baseSelect?.value === option.value) {
                            mustResetBase = true;
                        }
                    });

                    if (mustResetBase && baseSelect) {
                        baseSelect.value = "fixed";
                    }
                };

                const updateStanceVisibility = (plan) => {
                    const stanceRow = document.getElementById("row_stance");
                    const showStance = plan === "anomaly" || plan === "custom";
                    setHidden(stanceRow, !showStance);
                    if (showStance) return;

                    const stanceInput = document.getElementById("stance_mult");
                    if (stanceInput) stanceInput.value = "1";
                };

                const updateSuperCondVisibility = (plan) => {
                    const superWrapper = document
                        .getElementById("is_super_cond")
                        ?.closest(".mb-4");
                    const showSuper = plan === "sense" || plan === "custom";
                    setHidden(superWrapper, !showSuper);
                };

                const updateCoeffInputsState = (plan) => {
                    const coeffInputs = [
                        document.getElementById("n_conc"),
                        document.getElementById("n_cond"),
                    ];
                    const disableCoeff = plan === "logic" || plan === "anomaly";
                    coeffInputs.forEach((input) => {
                        if (!input) return;
                        input.disabled = disableCoeff;
                        input.classList.toggle("opacity-50", disableCoeff);
                        input.classList.toggle("cursor-not-allowed", disableCoeff);
                    });
                };

                const updatePlanVisibility = (plan) => {
                    updatePlanGroupVisibility(plan);
                    updateBaseModeVisibility(plan);
                    updateStanceVisibility(plan);
                    updateSuperCondVisibility(plan);
                    updateCoeffInputsState(plan);
                };

                const mapPlanParams = (state) => {
                    const baseSources = {
                        conc: state.conc,
                        cond: state.cond,
                        genki: state.genki,
                        motivation: state.motivation,
                        impression: state.impression,
                        totalAllout: state.totalAllout,
                    };

                    const mapLogicPlanParams = () => ({
                        ...state,
                        conc: state.prideBuffEnabled ? state.motivation : 0,
                        cond: state.prideBuffEnabled ? state.impression : 0,
                        growth: 0,
                        enthusiasm: 0,
                        stance: 1,
                        buff: state.buff,
                        baseSources,
                    });

                    const mapAnomalyPlanParams = () => {
                        const growthDisabled = state.anomalyGrowthDisabled;
                        const appliedGrowth = growthDisabled ? 0 : state.growth;
                        return {
                            ...state,
                            conc: state.enthusiasm,
                            cond: appliedGrowth,
                            growth: appliedGrowth + state.totalAllout * state.alloutRate,
                            enthusiasm: state.enthusiasm,
                            stance: state.stance,
                            buff: state.buff,
                            baseSources,
                        };
                    };

                    const mapCustomPlanParams = () => ({
                        ...state,
                        conc: state.conc || state.genki,
                        cond: state.cond,
                        growth: state.growth + state.totalAllout,
                        enthusiasm: state.enthusiasm,
                        buff: state.buff,
                        baseSources,
                    });

                    const mapDefaultPlanParams = () => ({
                        ...state,
                        growth: 0,
                        enthusiasm: 0,
                        stance: 1,
                        buff: state.buff,
                        baseSources,
                    });

                    switch (state.planType) {
                        case "logic":
                            return mapLogicPlanParams();
                        case "anomaly":
                            return mapAnomalyPlanParams();
                        case "custom":
                            return mapCustomPlanParams();
                        default:
                            return mapDefaultPlanParams();
                    }
                };

                return { init };
            })();

            document.addEventListener("DOMContentLoaded", App.init);
        </script>
        <script>
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', function() {
                    navigator.serviceWorker.register('/gakmas-score-calculator/service-worker.js')
                        .then(function(registration) {
                            console.log('ServiceWorker registration successful:', registration);
                        })
                        .catch(function(error) {
                            console.log('ServiceWorker registration failed:', error);
                        });
                });
            }
        </script>
        </body>
</html>
