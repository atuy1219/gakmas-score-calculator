<!doctype html>
<html lang="ja" class="light">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>学マス スコア最適化 & 比較</title>
        <link rel="manifest" href="manifest.json">
        <meta name="theme-color" content="#1976d2">
        <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
        <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="default">
        <meta name="apple-mobile-web-app-title" content="GakmasCalc">
        <link rel="apple-touch-icon" href="icon-192.png">
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet" />
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            tailwind.config = {
                darkMode: "class",
                theme: {
                    fontFamily: {
                        sans: ["Noto Sans JP", "sans-serif"],
                    },
                    extend: {
                        colors: {
                            slate: {
                                850: "#1e293b",
                                950: "#020617",
                            },
                            indigo: {
                                50: "#fff7ed",
                                100: "#ffedd5",
                                200: "#fed7aa",
                                300: "#fdba74",
                                400: "#fb923c",
                                500: "#f97316",
                                600: "#ea580c",
                                700: "#c2410c",
                                800: "#9a3412",
                                900: "#7c2d12",
                                950: "#431407",
                            },
                        },
                    },
                },
            };
        </script>
        <style>
            body {
                font-family: "Noto Sans JP", sans-serif;
                transition: background-color 0.3s, color 0.3s;
            }
            /* トグルスイッチの動作 */
            .toggle-checkbox:checked {
                right: 0;
                border-color: #f97316;
            }
            .toggle-checkbox:checked + .toggle-label {
                background-color: #ea580c;
            }
            /* カスタムスクロールバー（ダークモード用） */
            .dark ::-webkit-scrollbar {
                width: 8px;
            }
            .dark ::-webkit-scrollbar-track {
                background: #0f172a;
            }
            .dark ::-webkit-scrollbar-thumb {
                background: #334155;
                border-radius: 4px;
            }
            .dark ::-webkit-scrollbar-thumb:hover {
                background: #475569;
            }
        </style>
    </head>
    <body
        class="bg-slate-100 text-slate-800 dark:bg-slate-950 dark:text-slate-200 p-4 md:p-8 transition-colors duration-300"
    >
        <div class="max-w-6xl mx-auto relative">
            <div class="absolute top-0 right-0 z-10">
                <button
                    id="theme_toggle"
                    class="p-2 rounded-full bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 shadow-sm border border-slate-200 dark:border-slate-700 transition-all focus:outline-none"
                >
                    <svg
                        id="icon_sun"
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-6 w-6 hidden dark:block"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
                        />
                    </svg>
                    <svg
                        id="icon_moon"
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-6 w-6 block dark:hidden"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                        />
                    </svg>
                </button>
            </div>

            <header class="mb-6 pr-12">
                <h1
                    class="text-2xl font-bold text-slate-800 dark:text-slate-100"
                >
                    ダメージ最適化比較ツール
                </h1>
                <p class="text-slate-500 dark:text-slate-400 text-sm">
                    現在のリソース配分と、特定された計算式に基づいた理想配分を比較します
                </p>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <div class="lg:col-span-4 space-y-4">
                    <!-- Plan Type Selector -->
                    <div
                        class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 p-5 transition-colors duration-300"
                    >
                        <h2
                            class="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase mb-4 border-b dark:border-slate-800 pb-2"
                        >
                            プラン
                        </h2>
                        <div class="grid grid-cols-4 gap-2">
                            <label class="cursor-pointer">
                                <input
                                    type="radio"
                                    name="plan_type"
                                    value="sense"
                                    class="peer sr-only"
                                    checked
                                />
                                <div
                                    class="rounded-lg border border-slate-200 dark:border-slate-700 p-2 text-center peer-checked:border-indigo-500 peer-checked:bg-indigo-50 dark:peer-checked:bg-indigo-900/20 peer-checked:text-indigo-600 dark:peer-checked:text-indigo-300 transition-all hover:bg-slate-50 dark:hover:bg-slate-800"
                                >
                                    <span class="font-bold text-xs sm:text-sm"
                                        >センス</span
                                    >
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input
                                    type="radio"
                                    name="plan_type"
                                    value="logic"
                                    class="peer sr-only"
                                />
                                <div
                                    class="rounded-lg border border-slate-200 dark:border-slate-700 p-2 text-center peer-checked:border-blue-500 peer-checked:bg-blue-50 dark:peer-checked:bg-blue-900/20 peer-checked:text-blue-600 dark:peer-checked:text-blue-300 transition-all hover:bg-slate-50 dark:hover:bg-slate-800"
                                >
                                    <span class="font-bold text-xs sm:text-sm"
                                        >ロジック</span
                                    >
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input
                                    type="radio"
                                    name="plan_type"
                                    value="anomaly"
                                    class="peer sr-only"
                                />
                                <div
                                    class="rounded-lg border border-slate-200 dark:border-slate-700 p-2 text-center peer-checked:border-purple-500 peer-checked:bg-purple-50 dark:peer-checked:bg-purple-900/20 peer-checked:text-purple-600 dark:peer-checked:text-purple-300 transition-all hover:bg-slate-50 dark:hover:bg-slate-800"
                                >
                                    <span class="font-bold text-xs sm:text-sm"
                                        >アノマリー</span
                                    >
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input
                                    type="radio"
                                    name="plan_type"
                                    value="custom"
                                    class="peer sr-only"
                                />
                                <div
                                    class="rounded-lg border border-slate-200 dark:border-slate-700 p-2 text-center peer-checked:border-indigo-500 peer-checked:bg-indigo-50 dark:peer-checked:bg-indigo-900/20 peer-checked:text-indigo-600 dark:peer-checked:text-indigo-300 transition-all hover:bg-slate-50 dark:hover:bg-slate-800"
                                >
                                    <span class="font-bold text-xs sm:text-sm"
                                        >カスタム</span
                                    >
                                </div>
                            </label>
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 p-5 transition-colors duration-300"
                    >
                        <h2
                            class="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase mb-4 border-b dark:border-slate-800 pb-2"
                        >
                            現在のステータス
                        </h2>

                        <div
                            class="mb-4 flex flex-col gap-2 bg-indigo-50 dark:bg-indigo-900/20 p-3 rounded-lg border border-indigo-100 dark:border-indigo-900/30"
                        >
                            <div class="flex items-center justify-between">
                                <span
                                    class="text-sm font-bold text-indigo-900 dark:text-indigo-300"
                                    >絶好調</span
                                >
                                <div
                                    class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in"
                                >
                                    <input
                                        type="checkbox"
                                        name="toggle"
                                        id="is_super_cond"
                                        class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer peer checked:right-0 checked:border-indigo-600 right-4 top-0 transition-all duration-300"
                                        checked
                                    />
                                    <label
                                        for="is_super_cond"
                                        class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 dark:bg-slate-600 cursor-pointer peer-checked:bg-indigo-600 transition-colors duration-300"
                                    ></label>
                                </div>
                            </div>
                        </div>

                        <div
                            id="row_sense"
                            data-plan-group="sense custom"
                            class="grid grid-cols-2 gap-3 mb-3"
                        >
                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1"
                                    >集中</label
                                >
                                <input
                                    type="number"
                                    id="actual_conc"
                                    value="50"
                                    class="w-full p-2 border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-indigo-500 input-param"
                                />
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1"
                                    >好調</label
                                >
                                <input
                                    type="number"
                                    id="actual_cond"
                                    value="50"
                                    class="w-full p-2 border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-indigo-500 input-param"
                                />
                            </div>
                        </div>

                        <div
                            data-plan-group="logic custom"
                            class="mb-3 flex flex-col gap-2 bg-fuchsia-50 dark:bg-fuchsia-900/20 p-3 rounded-lg border border-fuchsia-100 dark:border-fuchsia-900/30 pt-3 border-t border-slate-100 dark:border-slate-800 hidden"
                        >
                            <div class="flex items-center justify-between">
                                <span
                                    class="text-sm font-bold text-fuchsia-900 dark:text-fuchsia-300"
                                    >プライドバフ</span
                                >
                                <div
                                    class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in"
                                >
                                    <input
                                        type="checkbox"
                                        name="toggle"
                                        id="pride_buff_toggle"
                                        class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer peer checked:right-0 checked:border-fuchsia-600 right-4 top-0 transition-all duration-300"
                                    />
                                    <label
                                        for="pride_buff_toggle"
                                        class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 dark:bg-slate-600 cursor-pointer peer-checked:bg-fuchsia-600 transition-colors duration-300"
                                    ></label>
                                </div>
                            </div>
                            <p
                                class="text-[11px] text-fuchsia-600 dark:text-fuchsia-300"
                            >
                                有効時、好印象とやる気の小さい方×2%をスコア上昇量増加に加算
                            </p>
                        </div>

                        <div
                            id="row_logic"
                            data-plan-group="logic custom"
                            class="grid grid-cols-2 gap-3 mb-3 hidden"
                        >
                            <div>
                                <label
                                    class="block text-xs font-bold text-pink-600 dark:text-pink-500 mb-1"
                                    >好印象</label
                                >
                                <input
                                    type="number"
                                    id="logic_impression"
                                    value="0"
                                    class="w-full p-2 border border-pink-200 dark:border-pink-900/50 bg-pink-50 dark:bg-pink-900/10 text-pink-800 dark:text-pink-200 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-pink-500 input-param"
                                />
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-pink-600 dark:text-pink-500 mb-1"
                                    >好印象強化 (%)</label
                                >
                                <input
                                    type="number"
                                    id="impression_boost"
                                    value="0"
                                    class="w-full p-2 border border-pink-200 dark:border-pink-900/50 bg-pink-50 dark:bg-pink-900/10 text-pink-800 dark:text-pink-200 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-pink-500 input-param"
                                />
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-sky-600 dark:text-sky-500 mb-1"
                                    >やる気</label
                                >
                                <input
                                    type="number"
                                    id="logic_motivation"
                                    value="50"
                                    class="w-full p-2 border border-sky-200 dark:border-sky-900/50 bg-sky-50 dark:bg-sky-900/10 text-sky-800 dark:text-sky-200 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-sky-500 input-param"
                                />
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-emerald-600 dark:text-emerald-500 mb-1"
                                    >元気</label
                                >
                                <input
                                    type="number"
                                    id="logic_genki"
                                    value="50"
                                    class="w-full p-2 border border-emerald-200 dark:border-emerald-900/50 bg-emerald-50 dark:bg-emerald-900/10 text-emerald-800 dark:text-emerald-200 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-emerald-500 input-param"
                                />
                            </div>
                        </div>
                        <div
                            id="row_anomaly"
                            data-plan-group="anomaly custom"
                            class="grid grid-cols-2 gap-3 mb-3 pt-3 border-t border-slate-100 dark:border-slate-800 hidden"
                        >
                            <div>
                                <label
                                    class="block text-xs font-bold text-amber-600 dark:text-amber-500 mb-1"
                                    >成長</label
                                >
                                <input
                                    type="number"
                                    id="actual_growth"
                                    value="0"
                                    class="w-full p-2 border border-amber-200 dark:border-amber-900/50 bg-amber-50 dark:bg-amber-900/10 text-amber-800 dark:text-amber-200 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-amber-500 input-param"
                                />
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-rose-600 dark:text-rose-500 mb-1"
                                    >熱意</label
                                >
                                <input
                                    type="number"
                                    id="actual_enthusiasm"
                                    value="0"
                                    class="w-full p-2 border border-rose-200 dark:border-rose-900/50 bg-rose-50 dark:bg-rose-900/10 text-rose-800 dark:text-rose-200 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-rose-500 input-param"
                                />
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-teal-600 dark:text-teal-500 mb-1"
                                    >累計全力値</label
                                >
                                <input
                                    type="number"
                                    id="actual_total_allout"
                                    value="0"
                                    class="w-full p-2 border border-teal-200 dark:border-teal-900/50 bg-teal-50 dark:bg-teal-900/10 text-teal-800 dark:text-teal-200 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-teal-500 input-param"
                                />
                            </div>
                            <div class="col-span-2 text-[10px] text-slate-400">
                                指針倍率は下部の「係数・環境設定」で設定します
                            </div>
                        </div>

                        <div
                            id="total_res_box"
                            class="bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-xl border border-indigo-100 dark:border-indigo-900/30 text-center mt-4 transition-colors duration-300"
                        >
                            <p
                                class="text-xs text-indigo-500 dark:text-indigo-400 font-bold uppercase tracking-wider mb-1"
                            >
                                合計リソース (プラン主要2項目)
                            </p>
                            <p
                                class="text-2xl font-black text-indigo-700 dark:text-indigo-300"
                                id="total_res_display"
                            >
                                0
                            </p>
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 p-5 transition-colors duration-300"
                    >
                        <h2
                            class="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase mb-4 border-b dark:border-slate-800 pb-2"
                        >
                            カード情報
                        </h2>
                        <div class="space-y-3">
                            <div>
                                <div
                                    class="flex items-center justify-between mb-1"
                                >
                                    <label
                                        class="block text-xs font-bold text-slate-500 dark:text-slate-400"
                                        >基礎スコア</label
                                    >
                                    <select
                                        id="base_mode"
                                        class="text-xs border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-indigo-500 input-param"
                                    >
                                        <option value="fixed" selected>
                                            固定値
                                        </option>
                                        <option
                                            value="conc_percent"
                                            data-plan-group="sense custom"
                                        >
                                            集中の%
                                        </option>
                                        <option
                                            value="cond_percent"
                                            data-plan-group="sense custom"
                                        >
                                            好調の%
                                        </option>
                                        <option
                                            value="genki_percent"
                                            data-plan-group="logic custom"
                                        >
                                            元気の%
                                        </option>
                                        <option
                                            value="motivation_percent"
                                            data-plan-group="logic custom"
                                        >
                                            やる気の%
                                        </option>
                                        <option
                                            value="impression_percent"
                                            data-plan-group="logic custom"
                                        >
                                            好印象の%
                                        </option>
                                        <option
                                            value="allout_percent"
                                            data-plan-group="anomaly custom"
                                        >
                                            累計全力値%
                                        </option>
                                    </select>
                                </div>
                                <input
                                    type="number"
                                    id="base"
                                    value="15"
                                    step="0.1"
                                    class="w-full p-2 border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-indigo-500 input-param"
                                />
                                <p
                                    id="resolved_base_note"
                                    class="text-[10px] text-indigo-500 dark:text-indigo-300 mt-1"
                                >
                                    実際に計算に使われる基礎スコア:
                                </p>
                            </div>
                            <div
                                data-plan-group="sense custom"
                                class="grid grid-cols-2 gap-3"
                            >
                                <div>
                                    <label
                                        class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1"
                                        >集中係数</label
                                    >
                                    <input
                                        type="number"
                                        id="n_conc"
                                        value="1.0"
                                        step="0.1"
                                        class="w-full p-2 border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-indigo-500 input-param"
                                    />
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1"
                                        >好調係数</label
                                    >
                                    <input
                                        type="number"
                                        id="n_cond"
                                        value="1.0"
                                        step="0.1"
                                        class="w-full p-2 border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-indigo-500 input-param"
                                    />
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div id="row_stance">
                                    <label
                                        class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1"
                                        >指針倍率</label
                                    >
                                    <select
                                        id="stance_mult"
                                        class="w-full p-2 border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-indigo-500 input-param"
                                    >
                                        <option value="0">
                                            のんびり x0.00
                                        </option>
                                        <option value="0.25">
                                            温存2段階目 x0.25
                                        </option>
                                        <option value="0.5">
                                            温存1段階目 x0.50
                                        </option>
                                        <option value="1" selected>
                                            なし x1.00
                                        </option>
                                        <option value="2">
                                            強気1段階目 x2.00
                                        </option>
                                        <option value="2.5">
                                            強気2段階目 x2.50
                                        </option>
                                        <option value="3">全力 x3.00</option>
                                    </select>
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1"
                                        >スコア上昇量増加(%)</label
                                    >
                                    <input
                                        type="number"
                                        id="buff_rate"
                                        value="0"
                                        class="w-full p-2 border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-indigo-500 input-param"
                                    />
                                </div>
                            </div>
                            <div data-plan-group="anomaly custom">
                                <label
                                    class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1"
                                    >累計全力値加算率 (%)</label
                                >
                                <input
                                    type="number"
                                    id="allout_rate"
                                    value="0"
                                    class="w-full p-2 border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-indigo-500 input-param"
                                />
                            </div>
                            <div
                                data-plan-group="anomaly custom"
                                class="flex items-center justify-between"
                            >
                                <div>
                                    <p
                                        class="text-xs font-bold text-amber-600 dark:text-amber-400"
                                    >
                                        成長不適用（持続/発動予約）
                                    </p>
                                    <p class="text-[10px] text-slate-400">
                                        持続や発動予約で成長が乗らない場合にON
                                    </p>
                                </div>
                                <div
                                    class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in"
                                >
                                    <input
                                        type="checkbox"
                                        id="anomaly_growth_disable_toggle"
                                        class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer peer checked:right-0 checked:border-amber-500 right-4 top-0 transition-all duration-300"
                                    />
                                    <label
                                        for="anomaly_growth_disable_toggle"
                                        class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 dark:bg-slate-600 cursor-pointer peer-checked:bg-amber-500 transition-colors duration-300"
                                    ></label>
                                </div>
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1"
                                    >ターンボーナス (%)</label
                                >
                                <input
                                    type="number"
                                    id="turn_bonus"
                                    value="1500"
                                    class="w-full p-2 border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-indigo-500 input-param"
                                />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-8 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="damage_display_container">
                        <div
                            id="current_dmg_box"
                            class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 p-6 border-l-4 border-l-slate-300 dark:border-l-slate-600 transition-colors duration-300"
                        >
                            <div class="flex justify-between items-start">
                                <div>
                                    <p
                                        class="text-xs font-bold text-slate-400 uppercase tracking-wider"
                                        id="current_dmg_label"
                                    >
                                        Current Damage
                                    </p>
                                    <p
                                        class="text-3xl font-black text-slate-700 dark:text-slate-200 mt-1"
                                        id="current_dmg"
                                    >
                                        0
                                    </p>
                                </div>
                                <div class="text-right">
                                    <span
                                        class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 text-xs font-bold px-2 py-1 rounded"
                                        >現在</span
                                    >
                                    <p
                                        class="text-xs text-slate-500 dark:text-slate-400 mt-1"
                                        id="current_ratio"
                                    >
                                        --
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div
                            id="optimal_dmg_box"
                            class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 p-6 border-l-4 border-l-indigo-500 bg-indigo-50/50 dark:bg-indigo-900/10 transition-colors duration-300"
                        >
                            <div class="flex justify-between items-start">
                                <div>
                                    <p
                                        class="text-xs font-bold text-indigo-400 uppercase tracking-wider"
                                    >
                                        Optimal Damage
                                    </p>
                                    <p
                                        class="text-3xl font-black text-indigo-700 dark:text-indigo-300 mt-1"
                                        id="optimal_dmg"
                                    >
                                        0
                                    </p>
                                </div>
                                <div class="text-right">
                                    <span
                                        class="bg-indigo-100 dark:bg-indigo-900/40 text-indigo-600 dark:text-indigo-300 text-xs font-bold px-2 py-1 rounded"
                                        >理想</span
                                    >
                                    <p
                                        class="text-xs text-indigo-600 dark:text-indigo-400 mt-1 font-bold"
                                        id="optimal_ratio"
                                    >
                                        --
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 p-6 transition-colors duration-300"
                    >
                        <div class="flex justify-between items-end mb-4">
                            <h3
                                class="font-bold text-slate-700 dark:text-slate-200"
                            >
                                配分シミュレーション
                            </h3>
                            <p
                                id="diff_text"
                                class="text-sm font-bold text-slate-400"
                            >
                                機会損失: 0
                            </p>
                        </div>
                        <div class="h-64 relative w-full">
                            <canvas id="optChart"></canvas>
                        </div>
                        <div class="h-64 relative w-full mt-8 hidden" id="optChart2Container">
                            <canvas id="optChart2"></canvas>
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden transition-colors duration-300"
                    >
                        <div
                            class="bg-slate-50 dark:bg-slate-800 border-b dark:border-slate-700 px-6 py-3"
                        >
                            <h3
                                class="font-bold text-slate-700 dark:text-slate-200 text-sm"
                            >
                                計算ステップ詳細比較
                            </h3>
                        </div>
                        <table class="w-full text-sm text-left">
                            <thead
                                class="text-slate-500 dark:text-slate-400 bg-slate-50/50 dark:bg-slate-800/50 border-b dark:border-slate-700"
                            >
                                <tr>
                                    <th
                                        class="px-6 py-3 font-medium text-xs uppercase w-1/3"
                                    >
                                        Step
                                    </th>
                                    <th
                                        class="px-6 py-3 font-medium text-xs uppercase w-1/3"
                                    >
                                        現在の構成
                                    </th>
                                    <th
                                        class="px-6 py-3 font-medium text-xs uppercase w-1/3 text-indigo-600 dark:text-indigo-400"
                                    >
                                        理想的な構成
                                    </th>
                                </tr>
                            </thead>
                            <tbody
                                class="divide-y divide-slate-100 dark:divide-slate-700 text-slate-700 dark:text-slate-300"
                                id="step_table"
                            ></tbody>
                        </table>
                        
                        <div class="mt-4 p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg text-xs font-mono text-slate-500 dark:text-slate-400 break-all">
                            <p class="font-bold mb-1 text-slate-400 dark:text-slate-500 uppercase tracking-wider">計算式 (現在の構成)</p>
                            <div id="formula_display"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            /**
             * Core Logic Module
             * 計算ロジックを純粋関数として分離
             */
            const Calculator = (() => {
                const round = (val, mode) => {
                    const v = Number(val.toFixed(10));
                    switch (mode) {
                        case "ceil":
                            return Math.ceil(v);
                        case "floor":
                            return Math.floor(v);
                        case "round":
                            return Math.round(v);
                        default:
                            return v;
                    }
                };

                const resolveBase = (baseVal, mode, sources) => {
                    const safe = sources || {};
                    const {
                        conc = 0,
                        cond = 0,
                        genki = 0,
                        motivation = 0,
                        impression = 0,
                        totalAllout = 0,
                    } = safe;
                    switch (mode) {
                        case "conc_percent":
                            return conc * (baseVal / 100);
                        case "cond_percent":
                            return cond * (baseVal / 100);
                        case "genki_percent":
                            return genki * (baseVal / 100);
                        case "motivation_percent":
                            return motivation * (baseVal / 100);
                        case "impression_percent":
                            return impression * (baseVal / 100);
                        case "allout_percent":
                            return totalAllout * (baseVal / 100);
                        default:
                            return baseVal;
                    }
                };

                const calculateDamage = (params) => {
                    const {
                        base,
                        baseMode,
                        conc,
                        nConc,
                        cond,
                        nCond,
                        stance,
                        buff,
                        turn,
                        growth,
                        enthusiasm,
                        isSuper,
                        baseSources,
                        planType,
                        impression,
                        motivation,
                        prideBuffEnabled,
                        impressionBoost,
                    } = params;
                    const steps = [];
                    const isLogicLike =
                        planType === "logic" || planType === "anomaly";
                    const effectiveNConc = isLogicLike ? 0 : nConc;
                    const effectiveNCond = isLogicLike ? 0 : nCond;

                    const resolvedBase = resolveBase(
                        base,
                        baseMode ?? "fixed",
                        baseSources ?? { conc, cond },
                    );

                    // 好印象強化 (通常1.0, 50%なら1.5)
                    const impBoostMult = 1 + (impressionBoost || 0) / 100;
                    const resolvedBaseBoosted = resolvedBase * impBoostMult;

                    // Step 1: 基礎値計算 (Ceil)
                    const raw1 =
                        resolvedBaseBoosted +
                        conc * effectiveNConc +
                        growth +
                        enthusiasm;
                    const val1 = round(raw1, "ceil");
                    steps.push({ label: "基礎スコア", val: val1 });

                    // Step 2: 好調・絶好調補正 & 指針 (None)
                    let condMultBase = 0;
                    let labelPrefix = "通常";
                    if (isSuper) {
                        if (cond > 0) {
                            condMultBase = 0.5 + cond / 10.0;
                            labelPrefix = "絶好調";
                        } else {
                            condMultBase = 0;
                            labelPrefix = "通常";
                        }
                    } else {
                        if (cond > 0) {
                            condMultBase = 0.5;
                            labelPrefix = "好調";
                        }
                    }
                    const totalCondMult = 1 + condMultBase * effectiveNCond;
                    
                    const raw2 = val1 * totalCondMult * stance;
                    const val2 = raw2;
                    steps.push({ label: `${labelPrefix}・指針`, val: val2 });

                    // Step 3: スコア上昇量増加バフ (Ceil)
                    const prideBuff = prideBuffEnabled
                        ? Math.min(
                              0.5,
                              0.02 * Math.min(impression ?? 0, motivation ?? 0),
                          )
                        : 0;
                    const totalBuff = buff + prideBuff;
                    const raw3 = val2 * (1 + totalBuff);
                    const val3 = round(raw3, "ceil");
                    steps.push({ label: "スコア上昇量増加", val: val3 });

                    // Step 4: ターン倍率 (Ceil)
                    const raw4 = val3 * turn;
                    const val4 = round(raw4, "ceil");
                    steps.push({ label: "最終ダメージ", val: val4 });

                    // 計算式表示用の文字列生成
                    const formulaParts = [];
                    formulaParts.push(`1. 基礎: ceil(${resolvedBase.toFixed(1)}${impBoostMult !== 1 ? `×${impBoostMult}` : ''} + ${conc}×${effectiveNConc} + ${growth} + ${enthusiasm}) = ${val1}`);
                    
                    const condStr = effectiveNCond > 0 ? `(1 + ${condMultBase}×${effectiveNCond})` : "1";
                    formulaParts.push(`2. 倍率: ${val1} × ${condStr} × ${stance} = ${val2.toFixed(2)}`);
                    
                    formulaParts.push(`3. バフ: ceil(${val2.toFixed(2)} × (1 + ${totalBuff.toFixed(3)})) = ${val3}`);
                    formulaParts.push(`4. 最終: ceil(${val3} × ${turn}) = ${val4}`);

                    return { final: val4, steps, resolvedBase, formula: formulaParts.join("<br>") };
                };

                const simulateOptimal = (params, totalResOverride) => {
                    let maxDmg = -1;
                    let bestConc = 0;
                    let bestResult = null;

                    const isCustom = params.planType === "custom";

                    // Customの場合のロジック用変数
                    let maxDmg2 = -1;
                    let bestRes2 = 0; // Logic側のX軸 (Motivation)
                    const chartData2 = { labels: [], data: [] };

                    const isLogicPride =
                        params.planType === "logic" && params.prideBuffEnabled;
                    
                    // Main optimization target (Sense / Logic / Custom-Main)
                    // Customの場合は Conc+Cond をまず計算
                    const totalRes =
                        typeof totalResOverride === "number"
                            ? totalResOverride
                            : isLogicPride
                              ? (params.motivation || 0) +
                                (params.impression || 0)
                              : (params.conc || 0) + (params.cond || 0);

                    const chartData = { labels: [], data: [] };

                    const skipOptimization =
                        params.planType === "anomaly" ||
                        (params.planType === "logic" &&
                            !params.prideBuffEnabled);
                            
                    if (skipOptimization) {
                        const currentResult = calculateDamage(params);
                        chartData.labels.push(
                            isLogicPride ? params.motivation : params.conc,
                        );
                        chartData.data.push(currentResult.final);
                        return {
                            maxDmg: currentResult.final,
                            bestConc: isLogicPride
                                ? params.motivation
                                : params.conc,
                            bestResult: currentResult,
                            chartData,
                            skipOptimization: true,
                        };
                    }

                    // 1. Main Optimization Loop
                    // Sense, Logic(if pride), Custom(Conc/Cond)
                    for (let c = 0; c <= totalRes; c++) {
                        const currentResB = totalRes - c;
                        
                        let simParams;
                        if (isLogicPride) {
                             simParams = {
                                  ...params,
                                  motivation: c,
                                  impression: currentResB,
                                  baseSources: {
                                      ...(params.baseSources || {}),
                                      motivation: c,
                                      impression: currentResB,
                                  },
                              };
                        } else {
                            // Sense or Custom (Main loop is Conc/Cond)
                             simParams = {
                                  ...params,
                                  conc: c,
                                  cond: currentResB,
                                  baseSources: {
                                      ...(params.baseSources || {}),
                                      conc: c,
                                      cond: currentResB,
                                  },
                              };
                        }
                        
                        const res = calculateDamage(simParams);

                        chartData.labels.push(c);
                        chartData.data.push(res.final);

                        if (res.final > maxDmg) {
                            maxDmg = res.final;
                            bestConc = c;
                            bestResult = res;
                        }
                    }

                    // 2. Secondary Optimization Loop for Custom (Motiv/Impression)
                    if (isCustom) {
                        const totalRes2 = (params.motivation || 0) + (params.impression || 0);
                        const baseEnthusiasm = (params.enthusiasm || 0) - (params.motivation || 0);
                        // baseCond logic is tricky because customized cond = (cond || impression).
                        // If cond was derived from impression, we should update it.
                        // If it came from explicit cond, update might not make sense unless we assume custom mode relationship.
                        // For simplicity, we assume custom mode users want to see impact on mapped stats too.
                        
                        for (let m = 0; m <= totalRes2; m++) {
                            const currentImp = totalRes2 - m;
                            
                            // Re-evaluate dependent params based on new motivation/impression
                            // enthusiasm = base + motivation
                            const newEnthusiasm = baseEnthusiasm + m;
                            
                            // cond = (original cond input) || impression. 
                            // If params.cond == params.impression (and params.cond was 0 originally), then it tracks.
                            // But we don't know original inputs here easily.
                            // Heuristic: If we are optimizing impression, and plan is custom, update cond if it seems linked?
                            // Safest is to just update impression and motivation, and let the user understand mappings, 
                            // BUT enthusiasm definitely needs update as it sums motivation.
                            // For cond, if we don't update it, impression only affects pride buff.
                            // Given request "Motivation, Impression graph", likely implies their effects.
                            // If impression maps to cond in custom, we should likely update cond too IF it was impression-based?
                            // Let's assume for this graph, we hold explicit Cond constant, but if Cond was inferred from Impression, it changes?
                            // Actually, calculating derived stats is best done by mapPlanParams if we had state.
                            // Without state, we update what we can.
                            
                            const simParams2 = {
                                ...params,
                                motivation: m,
                                enthusiasm: newEnthusiasm,
                                impression: currentImp,
                                baseSources: {
                                    ...(params.baseSources || {}),
                                    motivation: m,
                                    impression: currentImp,
                                },
                            };
                            
                            // If cond reflects impression in custom logic (cond || impression)
                            // We can't know for sure if cond came from impression or explicit cond without state.
                            // However, if we assume the user wants to see "Impression's effect", and impression affects cond...
                            // Let's try to update cond if it matches old impression?
                            if ((params.cond || 0) === (params.impression || 0) && (params.impression || 0) !== 0) {
                                 simParams2.cond = currentImp; // Linking them
                            } else if ((params.cond || 0) === 0 && (params.impression || 0) === 0) {
                                  // If both were 0, maybe they are linked?
                                 simParams2.cond = currentImp;
                            }
                            
                            const res2 = calculateDamage(simParams2);
                            
                            chartData2.labels.push(m);
                            chartData2.data.push(res2.final);

                            if (res2.final > maxDmg2) {
                                maxDmg2 = res2.final;
                                bestRes2 = m;
                            }
                        }
                    }

                    return {
                        maxDmg,
                        bestConc,
                        bestResult,
                        chartData,
                        chartData2: isCustom ? chartData2 : null,
                        maxDmg2: isCustom ? maxDmg2 : null,
                        bestRes2: isCustom ? bestRes2 : null,
                        skipOptimization: false,
                        isCustom
                    };
                };

                return { calculateDamage, simulateOptimal };
            })();

            /**
             * Theme Manager
             * ダークモード切り替え管理
             */
            const ThemeManager = (() => {
                let isDark = false;

                const init = () => {
                    // 保存された設定またはシステム設定を確認
                    if (
                        localStorage.theme === "dark" ||
                        (!("theme" in localStorage) &&
                            window.matchMedia("(prefers-color-scheme: dark)")
                                .matches)
                    ) {
                        isDark = true;
                    } else {
                        isDark = false;
                    }
                    apply();
                };

                const toggle = () => {
                    isDark = !isDark;
                    localStorage.theme = isDark ? "dark" : "light";
                    apply();
                    // チャートの色も更新するためイベント発火またはコールバック呼び出しが必要だが、
                    // 簡易的にApp.updateを呼ぶ設計にする
                    return isDark;
                };

                const apply = () => {
                    if (isDark) {
                        document.documentElement.classList.add("dark");
                    } else {
                        document.documentElement.classList.remove("dark");
                    }
                };

                const getChartColors = () => {
                    return isDark
                        ? {
                              grid: "#334155", // slate-700
                              text: "#94a3b8", // slate-400
                              line: "#fb923c", // orange-400
                          }
                        : {
                              grid: "#e2e8f0", // slate-200
                              text: "#64748b", // slate-500
                              line: "#f97316", // orange-500
                          };
                };

                return { init, toggle, getChartColors, isDark: () => isDark };
            })();

            /**
             * UI Controller
             */
            const App = (() => {
                let chartInstance = null;
                let chartInstance2 = null;

                const els = {
                    inputs: document.querySelectorAll(
                        ".input-param, #is_super_cond, #pride_buff_toggle, #anomaly_growth_disable_toggle",
                    ),
                    themeBtn: document.getElementById("theme_toggle"),
                    display: {
                        totalResBox: document.getElementById("total_res_box"),
                        totalRes: document.getElementById("total_res_display"),
                        currentDmg: document.getElementById("current_dmg"),
                        currentLabel: document.getElementById("current_dmg_label"),
                        optimalDmg: document.getElementById("optimal_dmg"),
                        optimalBox: document.getElementById("optimal_dmg_box"),
                        damageContainer: document.getElementById("damage_display_container"),
                        currentRatio: document.getElementById("current_ratio"),
                        optimalRatio: document.getElementById("optimal_ratio"),
                        diffText: document.getElementById("diff_text"),
                        stepTable: document.getElementById("step_table"),
                        resolvedBaseNote:
                            document.getElementById("resolved_base_note"),
                        formula: document.getElementById("formula_display"),
                    },
                    chartCanvas: document.getElementById("optChart"),
                    chartCanvas2: document.getElementById("optChart2"),
                    chart2Container: document.getElementById("optChart2Container"),
                };

                const getState = () => {
                    const getVal = (id) =>
                        parseFloat(document.getElementById(id)?.value) || 0;
                    const getInt = (id) =>
                        parseInt(document.getElementById(id)?.value) || 0;
                    const planType = document.querySelector(
                        'input[name="plan_type"]:checked',
                    )?.value;
                    return {
                        planType,
                        conc: getInt("actual_conc"),
                        cond: getInt("actual_cond"),
                        growth: getInt("actual_growth"),
                        enthusiasm: getInt("actual_enthusiasm"),
                        genki: getInt("logic_genki"),
                        motivation: getInt("logic_motivation"),
                        impression: getInt("logic_impression"),
                        impressionBoost: planType === 'logic' || planType === 'custom' ? getVal("impression_boost") : 0,
                        totalAllout: getInt("actual_total_allout"),
                        isSuper:
                            document.getElementById("is_super_cond").checked,
                        base: getVal("base"),
                        baseMode: document.getElementById("base_mode").value,
                        nConc: getVal("n_conc"),
                        nCond: getVal("n_cond"),
                        stance: getVal("stance_mult"),
                        buff: getVal("buff_rate") / 100,
                        turn: getVal("turn_bonus") / 100,
                        alloutRate: getVal("allout_rate") / 100,
                        anomalyGrowthDisabled:
                            document.getElementById(
                                "anomaly_growth_disable_toggle",
                            )?.checked || false,
                        prideBuffEnabled:
                            document.getElementById("pride_buff_toggle")
                                ?.checked || false,
                    };
                };

                const init = () => {
                    ThemeManager.init();
                    initChart();
                    attachEvents();
                    const selectedPlan =
                        document.querySelector(
                            'input[name="plan_type"]:checked',
                        )?.value || "sense";
                    updatePlanVisibility(selectedPlan);
                    update();
                };

                const attachEvents = () => {
                    els.inputs.forEach((input) =>
                        input.addEventListener("input", update),
                    );
                    document
                        .getElementById("base_mode")
                        .addEventListener("change", update);
                    document
                        .querySelectorAll('input[name="plan_type"]')
                        .forEach((radio) =>
                            radio.addEventListener("change", (e) => {
                                updatePlanVisibility(e.target.value);
                                update();
                            }),
                        );

                    els.themeBtn.addEventListener("click", () => {
                        ThemeManager.toggle();
                        updateChartTheme(); // チャートの色を更新
                    });
                };

                const initChart = () => {
                    const ctx = els.chartCanvas.getContext("2d");
                    const ctx2 = els.chartCanvas2.getContext("2d");
                    const colors = ThemeManager.getChartColors();

                    const createConfig = (xLabel) => ({
                        type: "line",
                        data: {
                            labels: [],
                            datasets: [
                                {
                                    label: "ダメージ",
                                    data: [],
                                    borderColor: colors.line,
                                    borderWidth: 2,
                                    tension: 0.3,
                                    pointRadius: 0,
                                    pointHoverRadius: 4,
                                },
                                {
                                    label: "現在",
                                    data: [],
                                    pointRadius: 6,
                                    pointBackgroundColor: "#64748b",
                                    pointBorderColor: "#fff",
                                    pointBorderWidth: 2,
                                    showLine: false,
                                },
                                {
                                    label: "理想",
                                    data: [],
                                    pointRadius: 6,
                                    pointBackgroundColor: "#f97316",
                                    pointBorderColor: "#fff",
                                    pointBorderWidth: 2,
                                    showLine: false,
                                },
                            ],
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { mode: "index", intersect: false },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: (ctx) =>
                                            `ダメージ: ${Number(ctx.raw.toFixed(2)).toLocaleString()}`,
                                    },
                                },
                            },
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: xLabel,
                                        color: colors.text,
                                        font: { size: 10 },
                                    },
                                    grid: { display: false },
                                    ticks: { color: colors.text },
                                },
                                y: {
                                    ticks: {
                                        callback: (val) => val.toLocaleString(),
                                        color: colors.text,
                                    },
                                    grid: { color: colors.grid },
                                },
                            },
                        },
                    });

                    chartInstance = new Chart(ctx, createConfig("集中 (Conc) の値"));
                    chartInstance2 = new Chart(ctx2, createConfig("やる気 (Motiv) の値"));
                };

                // テーマ切り替え時にチャートの設定を更新
                const updateChartTheme = () => {
                    const colors = ThemeManager.getChartColors();

                    [chartInstance, chartInstance2].forEach(chart => {
                        if (!chart) return;
                        chart.options.scales.x.title.color = colors.text;
                        chart.options.scales.x.ticks.color = colors.text;
                        chart.options.scales.y.ticks.color = colors.text;
                        chart.options.scales.y.grid.color = colors.grid;
                        chart.data.datasets[0].borderColor = colors.line;
                        chart.update();
                    });
                };

                const getTotalRes = (state, planAdjusted) => {
                    if (state.planType === "anomaly") return 0;
                    if (state.planType === "logic") {
                        return state.prideBuffEnabled
                            ? (state.motivation || 0) + (state.impression || 0)
                            : 0;
                    }
                    return (planAdjusted.conc || 0) + (planAdjusted.cond || 0);
                };

                const toggleTotalResBox = (planType, prideEnabled) => {
                    if (!els.display.totalResBox) return;
                    const shouldHide =
                        planType === "anomaly" ||
                        (planType === "logic" && !prideEnabled);
                    if (shouldHide) {
                        els.display.totalResBox.classList.add("hidden");
                    } else {
                        els.display.totalResBox.classList.remove("hidden");
                    }
                };

                const update = () => {
                    const state = getState();
                    const planAdjusted = mapPlanParams(state);
                    const totalRes = getTotalRes(state, planAdjusted);

                    toggleTotalResBox(state.planType, state.prideBuffEnabled);
                    if (els.display.totalRes) {
                        els.display.totalRes.innerText = totalRes;
                    }
                    const currentResult =
                        Calculator.calculateDamage(planAdjusted);
                    const modeLabel =
                        state.baseMode === "conc_percent"
                            ? `集中% (${state.base.toFixed(2)}%)`
                            : state.baseMode === "cond_percent"
                              ? `好調% (${state.base.toFixed(2)}%)`
                              : state.baseMode === "genki_percent"
                                ? `元気% (${state.base.toFixed(2)}%)`
                                : state.baseMode === "motivation_percent"
                                  ? `やる気% (${state.base.toFixed(2)}%)`
                                  : state.baseMode === "impression_percent"
                                    ? `好印象% (${state.base.toFixed(2)}%)`
                                    : state.baseMode === "allout_percent"
                                      ? `累計全力値% (${state.base.toFixed(2)}%)`
                                      : "固定値";
                    if (els.display.resolvedBaseNote) {
                        els.display.resolvedBaseNote.innerText = `実際に計算に使われる基礎スコア (${modeLabel}): ${Number(currentResult.resolvedBase.toFixed(2)).toLocaleString()}`;
                    }
                    const simResult = Calculator.simulateOptimal(
                        planAdjusted,
                        totalRes,
                    );

                    renderResults(
                        planAdjusted,
                        currentResult,
                        simResult,
                        totalRes,
                    );
                    
                    if (planAdjusted.planType === 'custom') {
                        if (els.chart2Container) els.chart2Container.classList.remove('hidden');
                        if (chartInstance) chartInstance.options.scales.x.title.text = "集中 (Conc)";
                        if (chartInstance2) chartInstance2.options.scales.x.title.text = "やる気 (Motivation)";
                    } else {
                        if (els.chart2Container) els.chart2Container.classList.add('hidden');
                        if (chartInstance) {
                             const isLogicPride = planAdjusted.planType === "logic" && planAdjusted.prideBuffEnabled;
                             chartInstance.options.scales.x.title.text = isLogicPride ? "やる気 (Motivation)" : "集中 (Conc)";
                         }
                    }

                    updateChartData(planAdjusted, simResult);
                };

                const renderResults = (state, current, best, totalRes) => {
                    els.display.currentDmg.innerText = Number(
                        current.final.toFixed(0),
                    ).toLocaleString();
                    els.display.optimalDmg.innerText = Number(
                        best.maxDmg.toFixed(0),
                    ).toLocaleString();
                    const isLogicPride =
                        state.planType === "logic" && state.prideBuffEnabled;
                    const labelA =
                        state.planType === "logic"
                            ? isLogicPride
                                ? "やる気"
                                : "元気"
                            : state.planType === "anomaly"
                              ? "熱意"
                              : state.planType === "custom"
                                ? "集中"
                                : "集中";
                    const labelB =
                        state.planType === "logic"
                            ? isLogicPride
                                ? "好印象"
                                : "好印象"
                            : state.planType === "anomaly"
                              ? "成長"
                              : state.planType === "custom"
                                ? "好調"
                                : "好調";
                    
                    let currentRatioText = `${labelA} ${state.conc} : ${labelB} ${state.cond}`;
                    let optimalRatioText = `${labelA} ${best.bestConc} : ${labelB} ${totalRes - best.bestConc}`;

                    if (state.planType === "custom" && state.prideBuffEnabled) {
                        currentRatioText += ` / やる気 ${state.motivation || 0} : 好印象 ${state.impression || 0}`;
                        if (best.bestRes2 !== null) {
                             const totalRes2 = (state.motivation || 0) + (state.impression || 0);
                             optimalRatioText += ` / やる気 ${best.bestRes2} : 好印象 ${totalRes2 - best.bestRes2}`;
                        }
                    }

                    els.display.currentRatio.innerText = currentRatioText;
                    els.display.optimalRatio.innerText = optimalRatioText;

                    const diff = best.maxDmg - current.final;
                    const diffPct =
                        best.maxDmg > 0
                            ? ((diff / best.maxDmg) * 100).toFixed(1)
                            : 0;

                    // Toggle Optimal Box visibility based on skipOptimization
                    const damageContainer = document.getElementById("damage_display_container");
                    const optimalBox = document.getElementById("optimal_dmg_box");
                    const currentLabel = document.getElementById("current_dmg_label");

                    if (best.skipOptimization) {
                        if (damageContainer) damageContainer.classList.remove("md:grid-cols-2");
                        if (optimalBox) optimalBox.classList.add("hidden");
                         // Optional: Change label to just "Damage" or "Score" if single view
                         if (currentLabel) currentLabel.innerText = "Damage / Score";
                        els.display.diffText.innerHTML = `<span class="text-slate-500">最適化対象外 (ロジック/アノマリー または プライド無効)</span>`;
                    } else {
                        if (damageContainer) damageContainer.classList.add("md:grid-cols-2");
                        if (optimalBox) optimalBox.classList.remove("hidden");
                        if (currentLabel) currentLabel.innerText = "Current Damage";

                        els.display.diffText.innerHTML =
                            diff > 0.001
                                ? `<span class="text-rose-500">機会損失: ${Math.floor(diff).toLocaleString()} (-${diffPct}%)</span>`
                                : `<span class="text-emerald-500">最適構成です (Loss: 0%)</span>`;
                    }

                    const rows = current.steps
                        .map((step, i) => {
                            const optStep = best.bestResult
                                ? best.bestResult.steps[i]
                                : step;
                            const isDifferent =
                                Math.abs(step.val - optStep.val) > 0.001;
                            const diffClass = isDifferent
                                ? "bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 font-bold"
                                : "text-slate-500 dark:text-slate-400";

                            return `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                    <td class="px-6 py-3 font-mono text-xs text-slate-400 border-r border-slate-100 dark:border-slate-800">Step ${i + 1}. <br><span class="text-slate-600 dark:text-slate-300 font-sans">${step.label}</span></td>
                    <td class="px-6 py-3 font-bold text-slate-700 dark:text-slate-200">${Number(step.val.toFixed(2)).toLocaleString()}</td>
                    <td class="px-6 py-3 ${diffClass}">${Number(optStep.val.toFixed(2)).toLocaleString()}</td>
                </tr>
            `;
                        })
                        .join("");

                    if (els.display.formula) {
                        const formula = current.formula || "";
                        els.display.formula.innerHTML = formula;
                    }
                    els.display.stepTable.innerHTML = rows;
                };

                const updateChartData = (planAdjusted, simResult) => {
                    if (!chartInstance) return;
                    
                    const labels = simResult.chartData.labels;
                    const data = simResult.chartData.data;
                    const currentConc = planAdjusted.planType === 'logic' && planAdjusted.prideBuffEnabled 
                        ? planAdjusted.motivation 
                        : planAdjusted.conc;

                    chartInstance.data.labels = labels;
                    chartInstance.data.datasets[0].data = data;
                    
                    // Current Point
                    chartInstance.data.datasets[1].data = labels.map((l) =>
                        Math.abs(l - currentConc) < 0.1 ? data[labels.indexOf(l)] : null
                    );
                    
                    // Best Point
                    chartInstance.data.datasets[2].data = labels.map((l) =>
                        Math.abs(l - simResult.bestConc) < 0.1 ? simResult.maxDmg : null
                    );
                    chartInstance.update();

                    // Chart 2 Update (Custom Only)
                    if (simResult.isCustom && chartInstance2 && simResult.chartData2) {
                        const labels2 = simResult.chartData2.labels;
                        const data2 = simResult.chartData2.data;
                        const currentMotiv = planAdjusted.motivation;

                        chartInstance2.data.labels = labels2;
                        chartInstance2.data.datasets[0].data = data2;
                        
                        // Current Point
                        chartInstance2.data.datasets[1].data = labels2.map((l) =>
                            Math.abs(l - currentMotiv) < 0.1 ? data2[labels2.indexOf(l)] : null
                        );
                        
                        // Best Point
                        chartInstance2.data.datasets[2].data = labels2.map((l) =>
                            Math.abs(l - simResult.bestRes2) < 0.1 ? simResult.maxDmg2 : null
                        );
                        chartInstance2.update();
                    }
                };

                const updatePlanVisibility = (plan) => {
                    const groups =
                        document.querySelectorAll("[data-plan-group]");
                    groups.forEach((el) => {
                        const plans = el.dataset.planGroup.split(" ");
                        if (plan === "custom" || plans.includes(plan)) {
                            el.classList.remove("hidden");
                        } else {
                            el.classList.add("hidden");
                        }
                    });
                    const baseSelect = document.getElementById("base_mode");
                    const baseOptions = document.querySelectorAll(
                        "#base_mode option[data-plan-group]",
                    );
                    let mustResetBase = false;
                    baseOptions.forEach((opt) => {
                        const plans = opt.dataset.planGroup.split(" ");
                        if (plan === "custom" || plans.includes(plan)) {
                            opt.classList.remove("hidden");
                        } else {
                            opt.classList.add("hidden");
                            if (baseSelect?.value === opt.value) {
                                mustResetBase = true;
                            }
                        }
                    });
                    if (mustResetBase && baseSelect) {
                        baseSelect.value = "fixed";
                    }
                    const stanceRow = document.getElementById("row_stance");
                    if (stanceRow) {
                        if (plan === "anomaly" || plan === "custom") {
                            stanceRow.classList.remove("hidden");
                        } else {
                            stanceRow.classList.add("hidden");
                            const stanceInput =
                                document.getElementById("stance_mult");
                            if (stanceInput) stanceInput.value = "1";
                        }
                    }
                    const superWrapper = document
                        .getElementById("is_super_cond")
                        ?.closest(".mb-4");
                    if (superWrapper) {
                        if (plan === "sense" || plan === "custom") {
                            superWrapper.classList.remove("hidden");
                        } else {
                            superWrapper.classList.add("hidden");
                        }
                    }

                    const coeffInputs = [
                        document.getElementById("n_conc"),
                        document.getElementById("n_cond"),
                    ];
                    const disableCoeff = plan === "logic" || plan === "anomaly";
                    coeffInputs.forEach((inp) => {
                        if (!inp) return;
                        inp.disabled = disableCoeff;
                        if (disableCoeff) {
                            inp.classList.add(
                                "opacity-50",
                                "cursor-not-allowed",
                            );
                        } else {
                            inp.classList.remove(
                                "opacity-50",
                                "cursor-not-allowed",
                            );
                        }
                    });
                };

                const mapPlanParams = (state) => {
                    const baseSources = {
                        conc: state.conc,
                        cond: state.cond,
                        genki: state.genki,
                        motivation: state.motivation,
                        impression: state.impression,
                        totalAllout: state.totalAllout,
                    };

                    switch (state.planType) {
                        case "logic":
                            return {
                                ...state,
                                conc: state.prideBuffEnabled
                                    ? state.motivation
                                    : 0,
                                cond: state.prideBuffEnabled
                                    ? state.impression
                                    : 0,
                                growth: 0,
                                enthusiasm: 0,
                                stance: 1,
                                buff: state.buff,
                                baseSources,
                            };
                        case "anomaly": {
                            const growthDisabled = state.anomalyGrowthDisabled;
                            const appliedGrowth = growthDisabled
                                ? 0
                                : state.growth;
                            return {
                                ...state,
                                conc: state.enthusiasm,
                                cond: appliedGrowth,
                                growth:
                                    appliedGrowth +
                                    state.totalAllout * state.alloutRate,
                                enthusiasm: state.enthusiasm,
                                stance: state.stance,
                                buff: state.buff,
                                baseSources,
                            };
                        }
                        case "custom":
                            return {
                                ...state,
                                conc: state.conc || state.genki,
                                cond: state.cond,
                                growth: state.growth + state.totalAllout,
                                enthusiasm: state.enthusiasm,
                                buff: state.buff,
                                baseSources,
                            };
                        default:
                            return {
                                ...state,
                                growth: 0,
                                enthusiasm: 0,
                                stance: 1,
                                buff: state.buff,
                                baseSources,
                            };
                    }
                };

                return { init };
            })();

            document.addEventListener("DOMContentLoaded", App.init);
        </script>
        <script>
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', function() {
                    navigator.serviceWorker.register('/gakmas-score-calculator/service-worker.js')
                        .then(function(registration) {
                            console.log('ServiceWorker registration successful:', registration);
                        })
                        .catch(function(error) {
                            console.log('ServiceWorker registration failed:', error);
                        });
                });
            }
        </script>
        </body>
</html>
